<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icons" href="youth_icon_192.png" type="image/png">
  <link rel="apple-touch-icon" href="youth_icon_512.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10183a">
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --accent:#a176ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
    .spacer{flex:1}
    header h1{margin:0;font-size:18px}
    .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}

    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
    .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162;flex-wrap:wrap}
    .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .toolbar .btn:hover{background:#1a2a56}
    .toolbar .stat{color:var(--muted);font-size:13px}
    .toolbar select{border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
    .counts{display:flex;gap:12px;align-items:center}
    .counts .pill{border-color:#2b3769}

    .grid{display:grid;gap:6px;padding:10px;grid-template-columns:1fr}
    .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:8px 10px;margin:2px 0;cursor:pointer;font-size:14px;line-height:1.28}
    .qbtn:hover{background:#121b3e}

    dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
    dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
    .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
    .btn.ok{background:#123b2a;border-color:#0d5b3a}
    .btn.danger{background:#3a1330;border-color:#7a244f}
    .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap}
    textarea{width:100%;background:#0b1330;color:var(--ink);border:1px solid #212c5c;border-radius:14px;padding:8px;resize:vertical;min-height:80px;font-size:14px;}

    .login-card{width:min(480px,92vw);margin:0 auto}

    #extraInfo { max-height:50vh; overflow:auto; resize:vertical; }
    .score{font-size:36px;font-weight:800}
    .answer-box, #extraInfo { font-size:14px; } 

    .blink{animation: blink 1s step-start 0s infinite}
    @keyframes blink{ 50%{ opacity: .2 } }

    /* ======== [ì¶”ê°€] ëª¨ë°”ì¼ ìµœì í™” & í™•ëŒ€ ìŠ¤ì¼€ì¼ ======== */
    :root { --scale: 1; }
    body { font-size: calc(16px * var(--scale)); }
    .qbtn { 
      font-size: calc(14px * var(--scale)); 
      padding: calc(10px * var(--scale)) 12px; 
      min-height: 44px;
    }
    .btn { min-height: 40px; }

    @media (max-width: 480px){
      header{ padding:12px 12px 6px }
      header h1{ font-size: clamp(16px, 5vw, 18px) }
      .wrap{ padding:8px 10px 24px }
      .toolbar{ gap:6px; padding:10px; }
      .toolbar .btn, .btn{ padding:12px 14px; min-height:44px; }
      .counts .pill{ display:none; }

      .grid{ gap:8px; padding:8px; grid-template-columns: 1fr; }
      .qbtn{ font-size: clamp(14px, 4vw, 16px); padding:12px 14px; }

      dialog{ width:100vw; height:100dvh; max-width:none; border-radius:0; }
      .dlg{ height:100%; overflow:auto; padding:12px; }
      #extraInfo{ min-height:120px; }
    }
    /* ======== [ì¶”ê°€ ë] ======== */
  </style>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8uvt7bkZokVkHT7nO0QRaB9WpEe2g2C4",
      authDomain: "youth-worker.firebaseapp.com",
      projectId: "youth-worker",
      storageBucket: "youth-worker.firebasestorage.app",
      messagingSenderId: "666890915384",
      appId: "1:666890915384:web:90381989a786934648a0cd",
      measurementId: "G-T1NCJXS15N"
    };

    try{
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      const auth = getAuth(app);

      window.__cloudReady = true;
      window.__fb = {
        app, db, auth,
        colShared : () => collection(db, "sharedData"),
        colProgress: () => collection(db, "progress"),
        colUsers   : () => collection(db, "users")
      };
      window.__fb_api = {
        getDoc, getDocs, setDoc, doc, deleteDoc, writeBatch,
        onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile
      };
      console.log('[firebase] initialized');
    }catch(e){
      console.warn('[firebase] init failed -> local fallback', e);
      window.__cloudReady = false;
    }
  </script>

  <!-- íŒŒì´ì–´ë² ì´ìŠ¤ ì‹¤íŒ¨ ì‹œ ì „ì—­ í´ë°± (UIëŠ” ê³„ì† ë™ì‘) -->
  <script>
    window.__cloudReady = window.__cloudReady || false;
    window.__fb       = window.__fb       || { db:null, auth:null, colShared:()=>({}), colProgress:()=>({}), colUsers:()=>({}) };
    window.__fb_api   = window.__fb_api   || {};
    window.__fb_api.getDocs   = window.__fb_api.getDocs   || (async ()=>({ forEach:()=>{} }));
    window.__fb_api.setDoc    = window.__fb_api.setDoc    || (async ()=>{});
    window.__fb_api.doc       = window.__fb_api.doc       || (()=>({}));
    window.__fb_api.deleteDoc = window.__fb_api.deleteDoc || (async ()=>{});
    window.__fb_api.writeBatch= window.__fb_api.writeBatch|| (()=>({ set(){}, commit:async()=>{} }));
    window.__fb_api.onAuthStateChanged = window.__fb_api.onAuthStateChanged || (()=>{});
    window.__fb_api.signInWithEmailAndPassword = window.__fb_api.signInWithEmailAndPassword || (async ()=>{ throw new Error('auth disabled'); });
    window.__fb_api.createUserWithEmailAndPassword = window.__fb_api.createUserWithEmailAndPassword || (async ()=>{ throw new Error('auth disabled'); });
    window.__fb_api.signOut = window.__fb_api.signOut || (async ()=>{});
    window.__fb_api.updateProfile = window.__fb_api.updateProfile || (async ()=>{});
  </script>
</head>
<body>
  <header>
    <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
    <h1>í•™ìŠµì‹œìŠ¤í…œ 6.0</h1>
    <div class="spacer"></div>
    <div id="headerRank" class="pill" style="display:none"></div>
    <div id="headerUser" class="pill" style="display:none"></div>
    <button id="logoutBtn" class="btn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <div class="wrap">
    <!-- ë¡œê·¸ì¸ -->
    <div id="loginPanel" class="panel">
      <div class="login-card" style="padding:20px;display:flex;flex-direction:column;gap:12px">
        <h2>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
        <input id="email" type="email" placeholder="ì´ë©”ì¼" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <input id="displayName" placeholder="í‘œì‹œ ì´ë¦„ (ì²˜ìŒ 1íšŒë§Œ)" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="loginBtn" class="btn primary">ë¡œê·¸ì¸</button>
          <button id="signupBtn" class="btn">íšŒì›ê°€ì…</button>
          <button id="resetPwBtn" class="btn">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
        </div>
        <!-- [ì¶”ê°€] ìë™ë¡œê·¸ì¸ ì²´í¬ -->
        <label style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <input id="autoLoginChk" type="checkbox">
          <span style="font-size:13px;color:var(--muted)">ìë™ë¡œê·¸ì¸ (ê°œì¸ ê¸°ê¸°ì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”)</span>
        </label>

        <div id="envErr" style="font-size:12px;color:#ffb3b3;min-height:18px"></div>
        <div id="rankList" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ë©”ì¸ -->
    <div id="mainPanel" class="panel" style="display:none">
      <div class="toolbar">
        <button id="resetProgress" class="btn">ì´ˆê¸°í™”</button>
        <button id="zoomBtn" class="btn">ê¸€ì í¬ê²Œ</button>
        <label for="subjectSelect" class="stat">ê³¼ëª© ì„ íƒ:</label>
        <select id="subjectSelect"></select>
        <div class="counts">
          <div class="pill" id="countTotal">ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ 0</div>
          <div class="pill" id="countLearned">ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ 0</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="addQuestionBtn" class="btn">ìƒˆ ì§ˆë¬¸ ì¶”ê°€</button>
          <button id="exportBtn" class="btn">ë‚´ë³´ë‚´ê¸°</button>
          <button id="importBtn" class="btn">ê°€ì ¸ì˜¤ê¸°</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <!-- ê´€ë¦¬ì ì „ìš© -->
          <button id="manageUsersBtn" class="btn" style="display:none">ì‚¬ìš©ì ê´€ë¦¬(ê´€ë¦¬ì)</button>
        </div>
      </div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- ì§ˆë¬¸ ëª¨ë‹¬ -->
  <dialog id="qd">
    <div class="dlg">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h2 id="qTitle" style="margin:0"></h2>
        <div><button id="deleteQuestionBtn" class="btn danger">ğŸ—‘ ì§ˆë¬¸ ì‚­ì œ</button></div>
      </div>

      <div class="row">
        <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>

        <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
        <button id="submitBtn" class="btn primary">âœ… ë‹µë³€ì™„ë£Œ</button>
        <button id="addAnswerBtn" class="btn" style="display:none">â• ì •ë‹µ ì¶”ê°€</button>

        <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
        <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>

        <!-- [ì¶”ê°€] ë§ˆì´í¬ ì„ íƒ & ë ˆë²¨ë¯¸í„° -->
        <select id="micSelect" class="btn" style="max-width:240px"></select>
        <div id="micLevel" style="width:120px;height:12px;background:#1a2248;border:1px solid #2b3769;border-radius:999px;overflow:hidden">
          <div id="micFill" style="height:100%;width:0%"></div>
        </div>
      </div>

      <div><div class="answer-box" id="userAnswer"></div></div>
      <div id="result"></div>

      <div id="extraAnswers"></div>

      <hr style="border:0;border-top:1px solid #1f2a55;margin:8px 0">
      <div>
        <h3>ì¶”ê°€ì„¤ëª…</h3>
        <textarea id="extraInfo" rows="5" placeholder="í•µì‹¬ ìš”ì , ë°°ê²½ì§€ì‹, ì˜ˆì‹œ ë“±ì„ ì ì–´ë‘ì„¸ìš”."></textarea>
        <button id="saveExtraInfoBtn" class="btn">ğŸ’¾ ì¶”ê°€ì„¤ëª… ì €ì¥</button>
        <button id="expandExtraInfoBtn" class="btn">ğŸ” ì „ì²´ë³´ê¸°</button>
        <button id="ttsExtraBtn" class="btn">ğŸ”Š ì¶”ê°€ì„¤ëª… ë“£ê¸°</button>
      </div>

      <div>
        <h3>ì¶”ê°€ì§ˆë¬¸ ë° ë‹µë³€</h3>
        <div id="followupsBox" class="answer-box" style="min-height:0"></div>
        <div class="row" style="align-items:flex-start">
          <textarea id="fuQ" rows="3" placeholder="ì¶”ê°€ì§ˆë¬¸"></textarea>
          <textarea id="fuA" rows="3" placeholder="ì¶”ê°€ë‹µë³€"></textarea>
          <button id="addFollowupBtn" class="btn">â• ì¶”ê°€ì§ˆë¬¸/ë‹µë³€ ì¶”ê°€</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- ìƒˆ ì§ˆë¬¸ ì¶”ê°€ ë‹¤ì´ì–¼ë¡œê·¸ -->
  <dialog id="addDlg">
    <div class="dlg">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h2 style="margin:0">ìƒˆ ì§ˆë¬¸ ì¶”ê°€</h2>
        <button id="addDlgClose" class="btn danger">ë‹«ê¸°</button>
      </div>
  
      <div class="pill" id="addDlgSubjectPill" style="margin-bottom:8px"></div>
  
      <div>
        <h3>ì§ˆë¬¸</h3>
        <textarea id="addQ" rows="3" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ì²­ì†Œë…„ ì •ì±…ì˜ 3ëŒ€ ì¶•ì€?"></textarea>
      </div>
  
      <div>
        <h3>ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)</h3>
        <div id="addAnswersBox" style="display:flex;flex-direction:column;gap:8px"></div>
        <div class="row">
          <button id="addAnsRowBtn" class="btn">â• ì •ë‹µ ì…ë ¥ì¹¸ ì¶”ê°€</button>
        </div>
        <div class="pill" style="margin-top:6px">ì²« ë²ˆì§¸ ì •ë‹µì´ ê¸°ë³¸ í™œì„± ì •ë‹µìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>
  
      <div>
        <h3>ì¶”ê°€ì„¤ëª…</h3>
        <textarea id="addExtra" rows="5" placeholder="í•µì‹¬ ìš”ì , ë°°ê²½ì§€ì‹, ì˜ˆì‹œ ë“±ì„ ì ì–´ë‘ì„¸ìš”."></textarea>
      </div>
  
      <div>
        <h3>ì¶”ê°€ì§ˆë¬¸ ë° ë‹µë³€</h3>
        <div id="addFollowupsBox" style="display:flex;flex-direction:column;gap:8px"></div>
        <div class="row">
          <button id="addFUrowBtn" class="btn">â• ì¶”ê°€ì§ˆë¬¸/ë‹µë³€ ì…ë ¥ì¹¸ ì¶”ê°€</button>
        </div>
      </div>
  
      <div class="row" style="justify-content:flex-end">
        <button id="addDlgSave" class="btn primary">âœ… ì €ì¥</button>
      </div>
    </div>
  </dialog>

  <!-- ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬(ê´€ë¦¬ì ì „ìš©) -->
  <dialog id="userMngDlg">
    <div class="dlg">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">ì‚¬ìš©ì ê´€ë¦¬</h2>
        <button id="userMngClose" class="btn danger">ë‹«ê¸°</button>
      </div>
      <div id="userMngList" style="display:flex;flex-direction:column;gap:8px"></div>
      <div class="pill" style="margin-top:8px">â€» ê´€ë¦¬ìëŠ” ëª©ë¡/ìˆœìœ„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</div>
    </div>
  </dialog>

  <script>
    /* ================= ê³µí†µ ìƒíƒœ/ìœ í‹¸ ================= */
    let raw = [];        // ì „ì²´ ë¬¸í•­(ê³µìœ )
    let data = [];       // ë¯¸ìŠµë“ë§Œ í‘œì‹œ
    let currentUser = null; // { uid, name, role }
    let currentIdx = null;
    let recognition = null;
    let recBlinkTimer = null;
    let recFinalOnly = '';  // ìµœì¢…ë§Œ ëª¨ì„ ë²„í¼

    const LS_SHARED = 'yj_shared_backup_v1';
    const LS_PROG   = 'yj_progress_backup_v1';
    const LS_LOCAL_OVR = 'yj_local_overrides_v1';

    const ADMIN_EMAILS = new Set([
      // í•„ìš” ì‹œ ê´€ë¦¬ì ì´ë©”ì¼ì„ ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš”. ì˜ˆ: 'admin@example.com'
    ]);

    const normSubj = s => {
      const v = (s??'').toString().trim();
      return v.length ? v : 'ê¸°íƒ€';
    };
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const qKey = q => `${normSubj(q.subject)}::${q.question}`;

    function showError(msg){
      const box = document.getElementById('envErr');
      if(box){ box.textContent = msg; }
      console.error('[APP]', msg);
    }

    function isAnswerObj(a){ return a && typeof a === 'object' && 'text' in a; }
    function answerText(a){ return isAnswerObj(a) ? a.text : String(a||''); }
    function answerOwnerName(a){ return isAnswerObj(a) ? (a.ownerName||'') : ''; }
    function answerOwnerUid(a){ return isAnswerObj(a) ? (a.ownerUid||'') : ''; }

    /* ================= ë¡œì»¬ í´ë°± ì €ì¥ì†Œ ================= */
    function lsGet(key, def){ try{ const v=localStorage.getItem(key); return v? JSON.parse(v): def; }catch{return def;} }
    function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    /* ====== ë¡œì»¬ ì˜¤ë²„ë ˆì´ í—¬í¼ ====== */
    function loadLocalOverrides(){
      return lsGet(LS_LOCAL_OVR, {});
    }
    function saveLocalOverride(id, patch){
      const ov = loadLocalOverrides();
      ov[id] = { ...(ov[id]||{}), ...patch };
      lsSet(LS_LOCAL_OVR, ov);
    }
    function deleteLocalOverride(id){
      const ov = loadLocalOverrides();
      delete ov[id];
      lsSet(LS_LOCAL_OVR, ov);
    }

    /* ================= Firestore ì§„ë‹¨ ================= */
    async function pingFirestore(){
      const box = document.getElementById('envErr');
      try{
        if(!window.__cloudReady){ box.textContent=''; return false; }
        const { getDocs } = window.__fb_api;
        await getDocs(window.__fb.colShared());
        box.textContent = '';
        return true;
      }catch(e){
        console.warn('[pingFirestore] Firestore unavailable (silent):', e?.code, e?.message);
        box.textContent = '';
        return false;
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>{ pingFirestore(); });

    /* ================= Users í—¬í¼ ================= */
    async function ensureUserProfile(user){
      try{
        if(!window.__cloudReady || !user) return;
        const { db } = window.__fb;
        const { doc, getDoc, setDoc, getDocs } = window.__fb_api;

        // users ë¹„ì–´ìˆìœ¼ë©´ ì²« ì‚¬ìš©ì admin
        let firstAdmin = false;
        try{
          const snapAll = await getDocs(window.__fb.colUsers());
          firstAdmin = snapAll.empty;
        }catch(_){}

        const ref = doc(db, 'users', user.uid);
        const snap = await getDoc(ref);
        const role = ADMIN_EMAILS.has(user.email) || firstAdmin ? 'admin' : 'user';
        if(!snap.exists()){
          await setDoc(ref, {
            uid:user.uid, email:user.email||'',
            displayName:user.displayName || (user.email? user.email.split('@')[0] : 'ì‚¬ìš©ì'),
            role, createdAt: new Date().toISOString()
          });
        }else{
          const d = snap.data()||{};
          const wantRole = ADMIN_EMAILS.has(user.email) ? 'admin' : (d.role||'user');
          if(d.role!==wantRole || d.displayName!==(user.displayName||d.displayName)){
            await setDoc(ref, { role: wantRole, displayName:user.displayName||d.displayName }, { merge:true });
          }
        }
      }catch(e){ console.warn('ensureUserProfile fail', e); }
    }
    async function loadUsersMap(){
      const map = new Map();
      try{
        if(!window.__cloudReady) return map;
        const { getDocs } = window.__fb_api;
        const snap = await getDocs(window.__fb.colUsers());
        snap.forEach(docSnap=>{
          const d=docSnap.data()||{};
          map.set(docSnap.id, { displayName: d.displayName||'ì‚¬ìš©ì', role: d.role||'user', email: d.email||'' });
        });
      }catch(e){ console.warn('[loadUsersMap] fail', e); }
      return map;
    }

    /* ================= ì§„í–‰ë„/í´ë¦­ ì¹´ìš´íŠ¸ ì €ì¥ì†Œ ================= */
    async function loadProgress(){
      if(window.__cloudReady){
        try{
          const { getDocs } = window.__fb_api;
          const snap = await getDocs(window.__fb.colProgress());
          const obj = {};
          snap.forEach(d => { obj[d.id] = d.data(); });
          // ë¡œì»¬ ì €ì¥ (ê¸°ì¡´ clicks í•„ë“œë¥¼ ë³´ì¡´)
          const local = lsGet(LS_PROG, {});
          const merged = { ...local, ...obj };
          lsSet(LS_PROG, merged);
          return merged;
        }catch(e){
          console.warn('[loadProgress] cloud fail -> local fallback', e);
        }
      }
      return lsGet(LS_PROG, {});
    }
    function getLocalUserProgress(uid){
      const all = lsGet(LS_PROG, {});
      return all[uid] || { learnedIds: [], clicks: {} };
    }
    function setLocalUserProgress(uid, patch){
      const all = lsGet(LS_PROG, {});
      const prev = all[uid] || { learnedIds: [], clicks: {} };
      all[uid] = { learnedIds: prev.learnedIds || [], clicks: prev.clicks || {}, ...patch,
                   learnedIds: patch.learnedIds ? Array.from(new Set(patch.learnedIds)) : (prev.learnedIds||[]),
                   clicks: { ...(prev.clicks||{}), ...(patch.clicks||{}) }
                 };
      lsSet(LS_PROG, all);
      return all[uid];
    }
    async function saveProgressForUser(uid, learnedIds){
      const prev = getLocalUserProgress(uid);
      const merged = setLocalUserProgress(uid, { learnedIds: learnedIds, clicks: prev.clicks||{} });
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db, "progress", uid), merged, { merge:true });
        }catch(e){
          console.warn('[saveProgressForUser] cloud fail (local kept)', e);
        }
      }
    }
    async function incrementUserClick(uid, qid){
      if(!uid) return;
      const prev = getLocalUserProgress(uid);
      const clicks = { ...(prev.clicks||{}) };
      clicks[qid] = (clicks[qid]||0) + 1;
      const merged = setLocalUserProgress(uid, { clicks });
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db, "progress", uid), { clicks }, { merge:true });
        }catch(e){
          console.warn('[incrementUserClick] cloud fail (local kept)', e);
        }
      }
      return merged.clicks[qid];
    }
    function getCurrentUserClicks(){
      if(!currentUser) return {};
      return getLocalUserProgress(currentUser.uid).clicks || {};
    }

    /* ================= ìˆœìœ„/í—¤ë” ================= */
    async function renderRanks(){
      const progress = await loadProgress();
      const usersMap = await loadUsersMap();
      const total = raw.length || 1;

      const rows = Object.keys(progress)
        .map(uid=>{
          const learned = (progress[uid]?.learnedIds || []).length;
          const rate = ((learned / total) * 100).toFixed(1);
          const info = usersMap.get(uid) || { displayName: 'ì‚¬ìš©ì', role: 'user' };
          return { uid, name: info.displayName || 'ì‚¬ìš©ì', role: info.role || 'user', learned, rate };
        })
        .filter(r=> r.role !== 'admin')
        .sort((a,b)=> b.learned - a.learned);

      const html = '<h3>í•™ìŠµì ìˆœìœ„</h3>' + (
        rows.length
          ? rows.map((r,i)=>`<div>${i+1}ìœ„ ${esc(r.name)} â€” ìŠµë“ìˆ˜: ${r.learned}, ìŠµë“ìœ¨: ${r.rate}%</div>`).join('')
          : '<div style="opacity:.7">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'
      );
      document.getElementById('rankList').innerHTML = html;
    }
    async function updateHeaderUser(){
      const rankEl = document.getElementById('headerRank');
      const userEl = document.getElementById('headerUser');
      const lo     = document.getElementById('logoutBtn');

      if(!currentUser){
        rankEl.style.display='none'; userEl.style.display='none'; lo.style.display='none';
        document.getElementById('manageUsersBtn').style.display='none';
        return;
      }
      const progress = await loadProgress();
      const my = progress[currentUser.uid]?.learnedIds || [];
      const myLearned = my.length;
      const total = raw.length || 1;
      const rate = ((myLearned / total) * 100).toFixed(1);

      const usersMap = await loadUsersMap();
      const rows = Object.keys(progress).map(uid=>{
        const learned = (progress[uid]?.learnedIds||[]).length;
        const info = usersMap.get(uid)||{role:'user'};
        return { uid, learned, role: info.role||'user' };
      }).filter(r=> r.role !== 'admin')
        .sort((a,b)=> b.learned - a.learned);
      const idx = rows.findIndex(r=> r.uid === currentUser.uid);

      rankEl.textContent = `ì´ë¬¸ì œìˆ˜: ${total} Â· ìŠµë“ìˆ˜: ${myLearned} Â· ìŠµë“ìœ¨: ${rate}% Â· ìˆœìœ„: ${idx>=0? (idx+1)+'ìœ„':'-'}`;
      userEl.textContent = `ì‚¬ìš©ì: ${currentUser.name}`;

      rankEl.style.display='inline-block';
      userEl.style.display='inline-block';
      lo.style.display    = 'inline-block';

      document.getElementById('manageUsersBtn').style.display = currentUser.role==='admin' ? 'inline-block' : 'none';
    }

    /* ===== í‘œì‹œì´ë¦„ì„ ì¦‰ì‹œ í—¤ë”ì— ë³´ì—¬ì£¼ê¸° ===== */
    function setHeaderImmediate(){
      if(!currentUser) return;
      const userEl = document.getElementById('headerUser');
      const lo     = document.getElementById('logoutBtn');
      userEl.textContent = `ì‚¬ìš©ì: ${currentUser.name}`;
      userEl.style.display = 'inline-block';
      lo.style.display = 'inline-block';
    }

    /* ================= ë² ì´ìŠ¤ ë°ì´í„° ================= */
    const FALLBACK = [
      { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ìƒë‹´ì—ì„œ ë¼í¬ì˜ í•µì‹¬ì€?', answers:['ì§„ì •ì„±, ê³µê°, ì¡´ì¤‘ì„ í†µí•´ ì‹ ë¢°ê´€ê³„ í˜•ì„±'], active:0, extraInfo:'ì‹ ë¢° í˜•ì„±ì„ ìœ„í•´ ìƒë‹´ìì˜ ì§„ì •ì„±Â·ê³µê°Â·ë¬´ì¡°ê±´ì  ì¡´ì¤‘ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.', followups:[{q:'í˜„ì¥ì—ì„œ ì ìš© ì‚¬ë¡€?',a:'ìƒí™©-í–‰ë™-ê²°ê³¼(SAR)ë¡œ ê°„ë‹¨íˆ ì„¤ëª….'}] },
      { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ ì •ì±…ì˜ 3ëŒ€ ì¶•ì€?', answers:['ë³´í˜¸, ì°¸ì—¬, ë°œë‹¬'], active:0, extraInfo:'ë³´í˜¸(ìœ„í—˜Â·ê¶Œë¦¬ì¹¨í•´ë¡œë¶€í„° ë³´í˜¸), ì°¸ì—¬(ì˜ì‚¬ê²°ì • ì°¸ì—¬), ë°œë‹¬(ê±´ê°•í•œ ì„±ì¥ ì§€ì›).', followups:[{q:'ê° ì¶•ì˜ ëŒ€í‘œì‚¬ì—…?',a:'ë³´í˜¸: ìœ„ê¸°ì²­ì†Œë…„ ì§€ì› / ì°¸ì—¬: ì²­ì†Œë…„ìš´ì˜ìœ„ / ë°œë‹¬: ì§„ë¡œÂ·ìê¸°ê°œë°œ'}] }
    ];
    async function loadBase(){
      try{
        const r=await fetch('youth_quiz_data.json',{cache:'no-store'});
        if(!r.ok) throw 0;
        const j=await r.json();
        return Array.isArray(j)&&j.length? j : FALLBACK;
      }catch{ return FALLBACK; }
    }
    function standardize(base){
      return base.map(x=>({
        subject: normSubj(x.subject),
        question: x.question,
        answers: Array.isArray(x.answers)? x.answers.filter(Boolean) : [(x.answer||'')].filter(Boolean),
        active: (typeof x.active==='number'? x.active:0),
        extraInfo: (typeof x.extraInfo==='string')? x.extraInfo : '',
        followups: Array.isArray(x.followups)? x.followups.filter(f=>f&&f.q&&f.a) : [],
        _localOnly: true
      }));
    }
    async function mergeWithShared(baseStd){
      const map=new Map();
      baseStd.forEach(q=> map.set(qKey(q), {...q}) );
      const shared = await loadShared();
      shared.forEach(q=>{
        const id=qKey(q);
        if(map.has(id)){
          const cur=map.get(id);
          const mergedAnswers = [...(cur.answers||[]), ...((q.answers||[]).filter(Boolean))];
          const uniq = [];
          const seen = new Set();
          for(const a of mergedAnswers){
            const t = (isAnswerObj(a)? a.text: String(a||'')).trim();
            if(!t) continue;
            if(seen.has(t)) continue;
            seen.add(t);
            uniq.push(a);
          }
          cur.answers = uniq;
          if(!cur.extraInfo && q.extraInfo) cur.extraInfo=q.extraInfo;
          const fu=Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a) : [];
          cur.followups=[...(cur.followups||[]), ...fu];
          cur._localOnly = cur._localOnly || false;
        }else{
          map.set(id,{
            subject:normSubj(q.subject),
            question:q.question,
            answers:(q.answers||[]).filter(Boolean),
            active:(q.active||0),
            extraInfo:(q.extraInfo||''),
            followups:Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a):[],
            _localOnly:false
          });
        }
      });
      const ov = loadLocalOverrides();
      for(const [id, q] of map){
        if(q._localOnly && ov[id]){
          const o = ov[id];
          if(o.answers) q.answers = o.answers;
          if(typeof o.active==='number') q.active = o.active;
          if(typeof o.extraInfo==='string') q.extraInfo = o.extraInfo;
          if(Array.isArray(o.followups)) q.followups = o.followups;
        }
      }
      raw=Array.from(map.values()).map((q,i)=>({...q,_idx:i}));
    }

    async function loadShared(){
      if(window.__cloudReady){
        try{
          const { getDocs } = window.__fb_api;
          const snap = await getDocs(window.__fb.colShared());
          const arr = [];
          snap.forEach(d => arr.push(d.data()));
          lsSet(LS_SHARED, arr);
          return arr;
        }catch(e){
          console.warn('[loadShared] cloud fail -> local fallback', e);
        }
      }
      return lsGet(LS_SHARED, []);
    }
    async function saveShared(array){
      lsSet(LS_SHARED, array);
      if(window.__cloudReady){
        try{
          const { writeBatch, doc } = window.__fb_api;
          const db = window.__fb.db;
          const batch = writeBatch(db);
          array.forEach(rec=>{
            const id = `${normSubj(rec.subject)}::${rec.question}`;
            batch.set(doc(db, "sharedData", id), rec, { merge:true });
          });
          await batch.commit();
        }catch(e){
          console.warn('[saveShared] cloud fail (local kept)', e);
        }
      }
    }
    async function persistQuestion(q){
      const id = qKey(q);
      if (q && q._localOnly){
        saveLocalOverride(id, {
          answers: (q.answers||[]),
          active:  (typeof q.active==='number'? q.active:0),
          extraInfo: (q.extraInfo||''),
          followups: Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a):[]
        });
        return;
      }
      const local = lsGet(LS_SHARED, []);
      const rec = { subject:q.subject, question:q.question, answers:q.answers||[], active:q.active||0, extraInfo:q.extraInfo||'', followups:q.followups||[] };
      const i = local.findIndex(x=> qKey(x)===id);
      if(i>=0) local[i]=rec; else local.push(rec);
      lsSet(LS_SHARED, local);
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db,"sharedData",id), rec, { merge:true });
        }catch(e){
          console.warn('[persistQuestion] cloud fail (local kept)', e);
        }
      }
    }
    async function deleteSharedQuestion(q){
      const id = qKey(q);
      if (q && q._localOnly){
        deleteLocalOverride(id);
        return;
      }
      const local = lsGet(LS_SHARED, []);
      lsSet(LS_SHARED, local.filter(x=> qKey(x)!==id));
      if(window.__cloudReady){
        try{
          const { deleteDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await deleteDoc(doc(db, "sharedData", id));
        }catch(e){
          console.warn('[deleteSharedQuestion] cloud fail (local kept)', e);
        }
      }
    }

    /* ================= ìƒ‰ìƒ(í´ë¦­ìˆ˜ ê¸°ë°˜, ë³´ìƒ‰ìœ¼ë¡œ ë³€í™”) ================= */
    function styleFromCount(n){
      const t = Math.max(0, Math.min(1, n/10)); // 0..1 (10íšŒì—ì„œ ìµœëŒ€ ë³€í™”)
      const baseHue = 230;
      const compHue = (baseHue + 180) % 360;
      const hue = baseHue*(1-t) + compHue*t;
      const sat = 40 + 30*t;
      const light = 22 + (20*t);
      const bg = `hsl(${hue}, ${sat}%, ${light}%)`;
      const border = `hsl(${hue}, ${sat+5}%, ${light-10}%)`;
      return { bg, border };
    }

    /* ================= ì‚¬ìš©ì í•„í„°/ì¹´ìš´íŠ¸ ================= */
    async function applyLearnedFilterForCurrentUser(){
      const p = await loadProgress();
      const learned = currentUser ? new Set((p[currentUser.uid]?.learnedIds)||[]) : new Set();
      data = raw.filter(q=> !learned.has(qKey(q))).map(q=>({...q}));
    }
    async function updateCounts(){
      const subj = currentSubject();
      const p = await loadProgress();
      const learnedIds = currentUser ? new Set((p[currentUser.uid]?.learnedIds || [])) : new Set();
      const subjectAll = raw.filter(q => normSubj(q.subject) === subj);
      const subjectTotal = subjectAll.length;
      const subjectLearned = subjectAll.reduce((acc,q)=>{
        return acc + (learnedIds.has(`${normSubj(q.subject)}::${q.question}`) ? 1 : 0);
      }, 0);
      document.getElementById('countTotal').textContent   = `ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ ${subjectTotal}`;
      document.getElementById('countLearned').textContent = `ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ ${subjectLearned}`;
    }

    /* ================= ê³¼ëª©/ë¦¬ìŠ¤íŠ¸ ================= */
    function subjects(){
      const list = raw.map(q => normSubj(q.subject));
      return Array.from(new Set(list)).sort((a,b)=> a.localeCompare(b));
    }
    function initSubjectSelect(){
      const sel = document.getElementById('subjectSelect');
      const prev = sel.value;
      const subs = subjects();
      sel.innerHTML = subs.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
      sel.value = subs.includes(prev) ? prev : (subs[0] || 'ê¸°íƒ€');
      sel.onchange = async ()=>{
        await renderBySubject(currentSubject());
        await updateCounts();
      };
      renderBySubject(currentSubject());
      updateCounts();
    }
    function currentSubject(){
      const sel=document.getElementById('subjectSelect');
      const subs = subjects();
      if(sel && sel.value && subs.includes(sel.value)) return sel.value;
      return subs[0] || 'ê¸°íƒ€';
    }
    async function renderBySubject(subj){
      const grid=document.getElementById('grid');
      if(!raw || raw.length===0){
        grid.innerHTML = `<div style="padding:12px;opacity:.7">ë¬¸í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (youth_quiz_data.jsonì„ í™•ì¸)</div>`;
        return;
      }
      const clicks = getCurrentUserClicks();
      const list=data.filter(x=>normSubj(x.subject)===subj)
        .map(q=>{
          const id = qKey(q);
          const cnt = clicks[id]||0;
          const { bg, border } = styleFromCount(cnt);
          const safeTitle = `${q.question} (ë‚˜ì˜ ì‹œë„ ${cnt}íšŒ)`;
          return `<button class="qbtn" style="background:${bg};border-color:${border}" onclick="openQuestion(${q._idx})" title="${esc(safeTitle)}">${esc(q.question)}</button>`;
        }).join('');
      if(list){
        grid.innerHTML=list;
      }else{
        const totalSubjCount = raw.filter(x=>normSubj(x.subject)===subj).length;
        grid.innerHTML = `<div style="padding:12px;opacity:.7">ì´ ê³¼ëª©ì˜ ë¯¸ìŠµë“ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.${totalSubjCount? ' (ëª¨ë“  ë¬¸í•­ì„ ìŠµë“í–ˆìŠµë‹ˆë‹¤)': ''}</div>`;
      }
    }

    /* ================= ì¸ì¦/ë¡œê·¸ì¸ íë¦„ ================= */
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const nameEl = document.getElementById('displayName');

    async function postLoginUI(){
      document.getElementById('loginPanel').style.display='none';
      document.getElementById('mainPanel').style.display='block';
      document.getElementById('logoutBtn').style.display='inline-block';
      document.getElementById('grid').innerHTML = '<div style="opacity:.7;padding:12px">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
      await quickRenderBase();
      await bootstrap();
      await renderRanks();
      await updateHeaderUser();
    }

    document.getElementById('loginBtn').onclick = async ()=>{
      try{
        const email=(emailEl.value||'').trim();
        const pass=passEl.value||'';
        if(!email||!pass){ showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const { signInWithEmailAndPassword } = window.__fb_api;
        await signInWithEmailAndPassword(window.__fb.auth, email, pass);
        const u = window.__fb.auth.currentUser;
        if (u) {
          await ensureUserProfile(u);
          let role = 'user';
          try{
            const usersMap = await loadUsersMap();
            role = (usersMap.get(u.uid)?.role)||'user';
          }catch(_){}
          currentUser = { uid: u.uid, name: u.displayName || (u.email ? u.email.split('@')[0] : 'ì‚¬ìš©ì'), role };
          setHeaderImmediate();
          await postLoginUI();
        }
      }catch(err){
        const code = err?.code || '';
        const map = {
          'auth/invalid-credential':'ìê²© ì¦ëª…ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤(ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ ë˜ëŠ” ë‹¤ë¥¸ ë¡œê·¸ì¸ ë°©ì‹).',
          'auth/user-not-found':'ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íšŒì›ê°€ì…ì„ í•´ì£¼ì„¸ìš”.',
          'auth/wrong-password':'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'
        };
        showError(map[code] || `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${code || err?.message || err}`);
      }
    };

    document.getElementById('signupBtn').onclick = async ()=>{
      try{
        const email=(emailEl.value||'').trim();
        const pass=passEl.value||'';
        const disp=(nameEl.value||'').trim();
        if(!email||!pass){ showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const { createUserWithEmailAndPassword, updateProfile } = window.__fb_api;
        const cred = await createUserWithEmailAndPassword(window.__fb.auth, email, pass);
        if(disp){ await updateProfile(cred.user, { displayName: disp }); }
        await ensureUserProfile(cred.user);
        showError('íšŒì›ê°€ì… ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.');
      }catch(err){
        const code = err?.code || '';
        const map = {
          'auth/email-already-in-use':'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì„ ì‚¬ìš©í•˜ì„¸ìš”.',
          'auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/weak-password':'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤(ìµœì†Œ 6ì).',
          'auth/operation-not-allowed':'Email/Password ì œê³µìê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
          'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'
        };
        showError(map[code] || `íšŒì›ê°€ì… ì‹¤íŒ¨: ${code || err?.message || err}`);
      }
    };

    document.getElementById('resetPwBtn').onclick = async ()=>{
      try{
        const email = (emailEl.value||'').trim();
        if(!email){ showError('ì¬ì„¤ì •í•  ì´ë©”ì¼ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const mod = await import('https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js');
        await mod.sendPasswordResetEmail(window.__fb.auth, email);
        showError('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì„ í™•ì¸í•˜ì„¸ìš”.');
      }catch(err){
        const code = err?.code || '';
        const map = {
          'auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/user-not-found':'í•´ë‹¹ ì´ë©”ì¼ì˜ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.',
          'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'
        };
        showError(map[code] || `ì¬ì„¤ì • ì‹¤íŒ¨: ${code || err?.message || err}`);
      }
    };

    document.getElementById('logoutBtn').onclick = async ()=>{
      try{
        const { signOut } = window.__fb_api;
        await signOut(window.__fb.auth);
      }catch(e){
        console.warn('[logout] fail', e);
      }finally{
        currentUser = null;
        document.getElementById('mainPanel').style.display='none';
        document.getElementById('loginPanel').style.display='block';
        document.getElementById('logoutBtn').style.display='none';
        document.getElementById('headerUser').style.display='none';
        document.getElementById('headerRank').style.display='none';
        document.getElementById('manageUsersBtn').style.display='none';
      }
    };

    /*================= ì¸ì¦ ìƒíƒœ ë³€í™” í•¸ë“¤ëŸ¬ =================*/
    (function watchAuth(){
      if(!window.__cloudReady) return;
      const { onAuthStateChanged } = window.__fb_api;
      onAuthStateChanged(window.__fb.auth, async (user)=>{
        if(user){
          await ensureUserProfile(user);
          let role='user';
          try{
            const usersMap = await loadUsersMap();
            role = (usersMap.get(user.uid)?.role)||'user';
          }catch(_){}
          currentUser = {
            uid: user.uid,
            name: user.displayName || (user.email ? user.email.split('@')[0] : 'ì‚¬ìš©ì'),
            role
          };
          const userEl = document.getElementById('headerUser');
          const lo = document.getElementById('logoutBtn');
          userEl.textContent = `ì‚¬ìš©ì: ${currentUser.name}`;
          userEl.style.display = 'inline-block';
          lo.style.display = 'inline-block';
          await postLoginUI();
        }else{
          currentUser = null;
          document.getElementById('mainPanel').style.display='none';
          document.getElementById('loginPanel').style.display='block';
          document.getElementById('logoutBtn').style.display='none';
          document.getElementById('manageUsersBtn').style.display='none';
          await renderRanks();
          await updateHeaderUser();
        }
      });
    })();

    /* ================= ì§„í–‰ë„ ì´ˆê¸°í™” ================= */
    document.getElementById('resetProgress').onclick = async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      await saveProgressForUser(currentUser.uid, []);
      await applyLearnedFilterForCurrentUser();
      await renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    };

    /* ================= ë¹ ë¥¸ 1ë‹¨ê³„ ë Œë” ================= */
    async function quickRenderBase(){
      const base = await loadBase();
      const std  = standardize(base);
      raw = std.map((q,i)=>({...q,_idx:i}));
      await applyLearnedFilterForCurrentUser();
      initSubjectSelect();
      const sel = document.getElementById('subjectSelect');
      if(sel && !sel.value){
        const subs = subjects();
        if(subs.length) sel.value = subs[0];
      }
      await renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    }

    /* ================= ì§ˆë¬¸ ëª¨ë‹¬/ìŒì„±/ìœ ì‚¬ë„/ì¶”ê°€ê¸°ëŠ¥ ================= */
    async function openQuestion(idx){
      currentIdx=idx;
      const q=raw.find(x=>x._idx===idx); if(!q) return;
      document.getElementById('qTitle').textContent=q.question;
      document.getElementById('userAnswer').textContent='';
      document.getElementById('result').innerHTML='';
      renderAnswerList();
      document.getElementById('extraInfo').value=q.extraInfo||'';
      renderFollowups();
      document.getElementById('qd').showModal();
      speak(q.question);

      // ì‚¬ìš©ìë³„ í´ë¦­ ì¹´ìš´íŠ¸ ì¦ê°€ + ë²„íŠ¼ ìƒ‰ ì¦‰ì‹œ ê°±ì‹ 
      if(currentUser){
        const id = qKey(q);
        await incrementUserClick(currentUser.uid, id);
        await renderBySubject(currentSubject());
      }
    }
    function closeQuestion(){
      stopRecognition(true);
      document.getElementById('qd').close();
    }
    window.openQuestion = openQuestion;
    document.getElementById('closeBtn').onclick = closeQuestion;

    function speak(txt){ const u=new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u); }
    document.getElementById('speakBtn').onclick = ()=>{ const q=raw.find(x=>x._idx===currentIdx); if(q) speak(q.question); };

    // ì¶”ê°€ì„¤ëª… ë“£ê¸°
    document.getElementById('ttsExtraBtn').onclick = ()=>{
      const txt = (document.getElementById('extraInfo').value||'').trim();
      if(!txt){ alert('ì¶”ê°€ì„¤ëª… ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      speak(txt);
    };

    function startRecognition(){
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!window.SpeechRecognition){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      recognition=new SpeechRecognition();
      recognition.lang='ko-KR'; recognition.continuous=true; recognition.interimResults=true;
      recFinalOnly = '';
      document.getElementById('userAnswer').innerHTML = `<span class="blink">ë‹µë³€ë…¹ìŒì¤‘.....:</span>`;
      recognition.onresult=(event)=>{
        for(let i=event.resultIndex;i<event.results.length;i++){
          const t=event.results[i][0].transcript;
          if(event.results[i].isFinal){ recFinalOnly += t + ' '; }
        }
      };
      recognition.start();
    }
    function stopRecognition(fromClose=false){
      if(recognition){
        try{ recognition.stop(); }catch(_){}
        recognition=null;
      }
      if(!fromClose){
        const clean = (recFinalOnly||'').replace(/\s+/g,' ').trim();
        document.getElementById('userAnswer').textContent = clean || '';
      }
    }
    document.getElementById('recordBtn').onclick = ()=>{ startRecognition(); };

    function similarity(a,b){
      const sa=new Set(String(a).split(/\s+/).filter(Boolean));
      const sb=new Set(String(b).split(/\s+/).filter(Boolean));
      let inter=0; sa.forEach(w=>{ if(sb.has(w)) inter++; });
      return inter/(sa.size+sb.size-inter||1);
    }
    function getActiveAnswerText(q){
      if(!q || !Array.isArray(q.answers) || !q.answers.length) return '';
      const idx = (q.active||0);
      const pick = q.answers[idx] || q.answers[0];
      return answerText(pick);
    }
    document.getElementById('submitBtn').onclick = ()=>{
      const q=raw.find(x=>x._idx===currentIdx);
      if(!q) return;
      stopRecognition(false);
      const gold=getActiveAnswerText(q);
      const user=document.getElementById('userAnswer').textContent;
      if(!gold){
        document.getElementById('result').innerHTML = `<div class='answer-box'>ì •ë‹µì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. <b>â€œì •ë‹µ ì¶”ê°€â€</b> ë²„íŠ¼ìœ¼ë¡œ ì •ë‹µì„ ë“±ë¡í•˜ì„¸ìš”.</div>`;
        return;
      }
      const sim=similarity(user,gold);
      document.getElementById('result').innerHTML = `<div class='answer-box'>${esc(gold)}</div><div class='score'>ìœ ì‚¬ë„ ${(sim*100).toFixed(1)}%</div>`;
      speak('ì •ë‹µì…ë‹ˆë‹¤. ' + gold);
    };

    document.getElementById('learnedBtn').onclick = async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      const q = raw.find(x=>x._idx===currentIdx); if(!q) return;
      const id = qKey(q);

      data = data.filter(item => qKey(item) !== id);
      await renderBySubject(currentSubject());
      closeQuestion();

      try{
        const all = await loadProgress();
        const mine = new Set((all[currentUser.uid]?.learnedIds || []));
        mine.add(id);
        await saveProgressForUser(currentUser.uid, Array.from(mine));
      }catch(e){ console.warn('[learned] ì €ì¥ ì‹¤íŒ¨ â€“ ë¡œì»¬ ìœ ì§€', e); }

      try{
        await updateCounts();
        await updateHeaderUser();
        await renderRanks();
      }catch(e){}
    };

    function canEditAnswer(ans){
      if(!currentUser) return false;
      if(currentUser.role==='admin') return true;
      const owner = answerOwnerUid(ans);
      return owner && owner === currentUser.uid;
    }

    function renderAnswerList(){
      const holder=document.getElementById('extraAnswers');
      const q=raw.find(x=>x._idx===currentIdx);
      if(!q){ holder.innerHTML=''; return; }

      const items=(q.answers||[]).map((ans,i)=>{
        const checked=(q.active||0)===i?'checked':'';
        const txt = answerText(ans);
        const ownerTag = answerOwnerName(ans) ? ` &lt;${esc(answerOwnerName(ans))}&gt;` : '';
        const delBtn = canEditAnswer(ans) ? `<button class="btn danger" data-del-ans="${i}">ğŸ—‘</button>` : '';
        return `<div style="display:flex;gap:8px;align-items:flex-start;margin:6px 0">
          <input type="radio" name="ansPick" value="${i}" ${checked} style="margin-top:4px"/>
          <div style="flex:1">${esc(txt)}${ownerTag}</div>
          ${delBtn}
        </div>`;
      }).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</div>';

      holder.innerHTML =
        `<div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0 6px; flex-wrap:wrap">
           <h3 style="margin:0">ì •ë‹µ ëª©ë¡</h3>
           <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
             <button id="addAnswerBtn_inline" class="btn">â• ì •ë‹µ ì¶”ê°€</button>
             <button id="ttsAnswerBtn_inline" class="btn">ğŸ”Š ì •ë‹µ ë“£ê¸°</button>
           </div>
         </div>` + items;

      holder.querySelectorAll('input[name="ansPick"]').forEach(r=>{
        r.addEventListener('change', async (e)=>{
          q.active = parseInt(e.target.value,10)||0;
          await persistQuestion(q);
        });
      });
      holder.querySelectorAll('[data-del-ans]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const i=parseInt(btn.getAttribute('data-del-ans'),10);
          const target = (q.answers||[])[i];
          if(!canEditAnswer(target)){ alert('ì´ ì •ë‹µì„ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
          q.answers.splice(i,1);
          if((q.active||0)>=q.answers.length) q.active=Math.max(0,q.answers.length-1);
          await persistQuestion(q);
          renderAnswerList();
        });
      });

      const addInline = holder.querySelector('#addAnswerBtn_inline');
      if(addInline){
        addInline.addEventListener('click', async ()=>{
          if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
          const val=prompt('ì¶”ê°€í•  ì •ë‹µ(ë³€í˜•)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!val) return;
          q.answers=q.answers||[];
          const rec = {
            text: val,
            ownerUid: currentUser.uid,
            ownerName: currentUser.name||'ì‚¬ìš©ì',
            createdAt: new Date().toISOString()
          };
          const exists = (q.answers||[]).some(a=>answerText(a)===val);
          if(!exists) q.answers.push(rec);
          q.active=q.answers.length-1;
          await persistQuestion(q);
          renderAnswerList();
        });
      }

      const ttsInline = holder.querySelector('#ttsAnswerBtn_inline');
      if(ttsInline){
        ttsInline.addEventListener('click', ()=>{
          const gold = getActiveAnswerText(q);
          if(!gold){ alert('ë“±ë¡ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
          speak(gold);
        });
      }
    }
    document.getElementById('addAnswerBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      const val=prompt('ì¶”ê°€í•  ì •ë‹µ(ë³€í˜•)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!val) return;
      q.answers=q.answers||[];
      const rec = {
        text: val,
        ownerUid: currentUser.uid,
        ownerName: currentUser.name||'ì‚¬ìš©ì',
        createdAt: new Date().toISOString()
      };
      const exists = (q.answers||[]).some(a=>answerText(a)===val);
      if(!exists) q.answers.push(rec);
      q.active=q.answers.length-1;
      await persistQuestion(q);
      renderAnswerList();
    };
    document.getElementById('saveExtraInfoBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      q.extraInfo=(document.getElementById('extraInfo').value||'').trim();
      await persistQuestion(q);
      alert('ì¶”ê°€ì„¤ëª…ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
    };
    (function(){
      const btn = document.getElementById('expandExtraInfoBtn');
      let expanded=false;
      const ta=document.getElementById('extraInfo');
      ta.style.maxHeight='50vh';
      ta.style.minHeight='80px';
      btn.addEventListener('click', ()=>{
        expanded=!expanded;
        if(expanded){
          ta.style.maxHeight='80vh';
          ta.style.minHeight='60vh';
          btn.textContent='ğŸ” ì ‘ê¸°';
        } else {
          ta.style.maxHeight='50vh';
          ta.style.minHeight='80px';
          btn.textContent='ğŸ” ì „ì²´ë³´ê¸°';
        }
      });
    })();
    function renderFollowups(){
      const box=document.getElementById('followupsBox');
      const q=raw.find(x=>x._idx===currentIdx);
      if(!q){ box.innerHTML=''; return; }
      const items=(q.followups||[]).map((f,i)=>`<div style="display:flex;gap:8px;flex-direction:column;border:1px solid #1f2a55;border-radius:10px;padding:8px;margin:6px 0">
        <div><b>Q${i+1}.</b> ${esc(f.q)}</div>
        <div><b>A${i+1}.</b> ${esc(f.a)}</div>
        <div><button class='btn danger' data-del-fu='${i}'>ğŸ—‘ ì‚­ì œ</button></div>
      </div>`).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì¶”ê°€ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      box.innerHTML=items;
      box.querySelectorAll('[data-del-fu]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const i=parseInt(btn.getAttribute('data-del-fu'),10);
          q.followups.splice(i,1);
          await persistQuestion(q);
          renderFollowups();
        });
      });
    }
    document.getElementById('addFollowupBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      const fq=(document.getElementById('fuQ').value||'').trim();
      const fa=(document.getElementById('fuA').value||'').trim();
      if(!fq||!fa){ alert('ì¶”ê°€ì§ˆë¬¸ê³¼ ì¶”ê°€ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      q.followups=q.followups||[];
      q.followups.push({q:fq,a:fa});
      document.getElementById('fuQ').value=''; document.getElementById('fuA').value='';
      await persistQuestion(q);
      renderFollowups();
    };

    /* ================= ìƒˆ ì§ˆë¬¸ ì¶”ê°€: í¼ ë‹¤ì´ì–¼ë¡œê·¸ ================= */
    function add_makeAnswerRow(value=''){
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.gap = '8px';
      wrap.style.alignItems = 'center';
    
      const ta = document.createElement('textarea');
      ta.rows = 2;
      ta.placeholder = 'ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)ì„ ì…ë ¥í•˜ì„¸ìš”';
      ta.style.flex = '1';
      ta.value = value || '';
    
      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = 'ğŸ—‘';
      del.onclick = () => wrap.remove();
    
      wrap.appendChild(ta);
      wrap.appendChild(del);
      return wrap;
    }
    function add_makeFUrow(qVal='', aVal=''){
      const card = document.createElement('div');
      card.style.border = '1px solid #1f2a55';
      card.style.borderRadius = '10px';
      card.style.padding = '8px';
      card.style.display = 'flex';
      card.style.flexDirection = 'column';
      card.style.gap = '6px';
    
      const tq = document.createElement('textarea');
      tq.rows = 2; tq.placeholder = 'ì¶”ê°€ì§ˆë¬¸';
      tq.value = qVal || '';
    
      const ta = document.createElement('textarea');
      ta.rows = 2; ta.placeholder = 'ì¶”ê°€ë‹µë³€';
      ta.value = aVal || '';
    
      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = 'ğŸ—‘ ì‚­ì œ';
      del.style.alignSelf = 'flex-end';
      del.onclick = () => card.remove();
    
      card.appendChild(tq);
      card.appendChild(ta);
      card.appendChild(del);
      return card;
    }
    
    function openAddDialog(){
      const dlg = document.getElementById('addDlg');
      const pill = document.getElementById('addDlgSubjectPill');
      const subj = currentSubject();
      pill.textContent = `ê³¼ëª©: ${subj} (ìë™ ì„¤ì •)`;
    
      // ì´ˆê¸°í™”
      document.getElementById('addQ').value = '';
      document.getElementById('addExtra').value = '';
      const ansBox = document.getElementById('addAnswersBox');
      ansBox.innerHTML = '';
      ansBox.appendChild(add_makeAnswerRow()); // ìµœì†Œ 1ì¹¸
      const fuBox = document.getElementById('addFollowupsBox');
      fuBox.innerHTML = '';
    
      dlg.showModal();
    }
    function closeAddDialog(){ document.getElementById('addDlg').close(); }
    
    async function saveAddDialog(){
      const subj = currentSubject();
      const q = (document.getElementById('addQ').value||'').trim();
      const extra = (document.getElementById('addExtra').value||'').trim();
      if(!q){ alert('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    
      const ansBox = document.getElementById('addAnswersBox');
      const ansTexts = Array.from(ansBox.querySelectorAll('textarea'))
        .map(t => (t.value||'').trim())
        .filter(Boolean);
      if(ansTexts.length === 0){
        alert('ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
    
      const fuBox = document.getElementById('addFollowupsBox');
      const fuCards = Array.from(fuBox.children);
      const followups = fuCards.map(card => {
        const [tq, ta] = card.querySelectorAll('textarea');
        const qv = (tq.value||'').trim();
        const av = (ta.value||'').trim();
        return (qv && av) ? { q: qv, a: av } : null;
      }).filter(Boolean);
    
      const answers = ansTexts.map((t) => ({
        text: t,
        ownerUid: currentUser?.uid || '',
        ownerName: currentUser?.name || '',
        createdAt: new Date().toISOString()
      }));
      const seed = {
        subject: subj,
        question: q,
        answers,
        active: 0,
        extraInfo: extra,
        followups
      };
    
      const id = `${subj}::${q}`;
      if(raw.some(x=> `${normSubj(x.subject)}::${x.question}` === id)){
        if(!confirm('ì´ë¯¸ ê°™ì€ ì§ˆë¬¸ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      }
    
      try{
        const current = await loadShared();
        current.push(seed);
        await saveShared(current);
        await bootstrap();
        closeAddDialog();
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(e){
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (e?.message||e));
      }
    }
    
    document.getElementById('addQuestionBtn').onclick = openAddDialog;
    document.getElementById('addDlgClose').addEventListener('click', closeAddDialog);
    document.getElementById('addDlgSave').addEventListener('click', saveAddDialog);
    document.getElementById('addAnsRowBtn').addEventListener('click', ()=>{
      document.getElementById('addAnswersBox').appendChild(add_makeAnswerRow());
    });
    document.getElementById('addFUrowBtn').addEventListener('click', ()=>{
      document.getElementById('addFollowupsBox').appendChild(add_makeFUrow());
    });

    document.getElementById('deleteQuestionBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      if(!confirm('ì´ ì§ˆë¬¸ì„ ëª¨ë“  ì‚¬ìš©ìì—ê²Œì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await deleteSharedQuestion(q);
      await bootstrap();
    };

    /* ================= ë¶€íŠ¸ìŠ¤íŠ¸ë© ================= */
    async function bootstrap(){
      const base=await loadBase();
      const std = standardize(base);
      await mergeWithShared(std);
      await applyLearnedFilterForCurrentUser();
      initSubjectSelect();
      await renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    }

    // ì´ˆê¸°: ë¡œê·¸ì¸ ì „ì—ë„ ìˆœìœ„(ê´€ë¦¬ì ì œì™¸) ë¨¼ì € ë³´ì—¬ì¤Œ
    (async () => {
      const base = await loadBase();
      const std  = standardize(base);
      raw = std.map((q,i)=>({...q,_idx:i}));
      await renderRanks();
    })();
  </script>

  <!-- ================= [ì¶”ê°€] OBS/ZOOM ìŠ¤íƒ€ì¼ ìˆ˜ìŒ + STT + í¸ì§‘/ì €ì¥ íŒ¨ì¹˜ ================= -->
  <script>
  // ìƒíƒœ
  let micStream = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let audioCtx = null;
  let analyser = null;
  let micRAF = null;
  let sttActive = false;
  let __recognition = null;

  function ensureSpeechRecognition(){
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    return !!window.SpeechRecognition;
  }

  async function listAudioInputs(){
    try{
      if(!micStream){
        const tmp = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true, channelCount:1, sampleRate:48000 }
        });
        tmp.getTracks().forEach(t=>t.stop());
      }
    }catch(_){}
    const devs = await navigator.mediaDevices.enumerateDevices();
    return devs.filter(d=> d.kind==='audioinput');
  }

  async function startMic(deviceId){
    stopMic();
    micStream = await navigator.mediaDevices.getUserMedia({
      audio:{
        deviceId: deviceId ? { exact: deviceId } : undefined,
        echoCancellation:true,
        noiseSuppression:true,
        autoGainControl:true,
        channelCount:1,
        sampleRate:48000
      }
    });
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(micStream, { mimeType: 'audio/webm' });
    mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.start(1000);

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    src.connect(analyser);
    drawMicLevel();
  }

  function stopMic(){
    if(micRAF){ cancelAnimationFrame(micRAF); micRAF=null; }
    if(analyser){ try{ analyser.disconnect(); }catch(_){ } analyser=null; }
    if(audioCtx){ try{ audioCtx.close(); }catch(_){ } audioCtx=null; }
    if(mediaRecorder){
      try{ if(mediaRecorder.state!=='inactive') mediaRecorder.stop(); }catch(_){}
      mediaRecorder = null;
    }
    if(micStream){
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
    }
    const fill = document.getElementById('micFill');
    if(fill){ fill.style.width = '0%'; fill.style.background = 'linear-gradient(90deg,#4cd97b,#6aa6ff)'; }
  }

  function drawMicLevel(){
    if(!analyser) return;
    const arr = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteTimeDomainData(arr);
    let peak = 0;
    for(let i=0;i<arr.length;i++){
      const v = Math.abs(arr[i]-128)/128;
      if(v>peak) peak=v;
    }
    const pct = Math.min(100, Math.round(peak*200));
    const fill = document.getElementById('micFill');
    if(fill){
      fill.style.width = pct + '%';
      fill.style.background = (pct<60) ? 'linear-gradient(90deg,#4cd97b,#6aa6ff)' :
                            (pct<85) ? 'linear-gradient(90deg,#ffd166,#faaa3c)' :
                                       'linear-gradient(90deg,#ff6a6a,#ff3c3c)';
    }
    micRAF = requestAnimationFrame(drawMicLevel);
  }

  async function renderMicSelect(){
    const sel = document.getElementById('micSelect');
    if(!sel) return;
    const list = await listAudioInputs();
    sel.innerHTML = list.map(d=>`<option value="${d.deviceId}">${d.label || 'ë§ˆì´í¬'}</option>`).join('') || '<option>ë§ˆì´í¬</option>';
    sel.onchange = async ()=>{ try{ await startMic(sel.value); }catch(e){ alert('ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨: '+(e?.message||e)); } };
    try{ await startMic(sel.value); }catch(e){ console.warn('ì´ˆê¸° ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨', e); }
  }

  function startContinuousSTT(){
    if(!ensureSpeechRecognition()){
      alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return false;
    }
    if(__recognition){ try{ __recognition.stop(); }catch(_){ } __recognition=null; }
    __recognition = new window.SpeechRecognition();
    __recognition.lang='ko-KR';
    __recognition.continuous=true;
    __recognition.interimResults=true;

    const userBox = document.getElementById('userAnswer');
    if(userBox){
      userBox.innerHTML = '<span class="blink">ë‹µë³€ë…¹ìŒì¤‘.....:</span>';
      userBox.contentEditable = 'true';
    }

    __recognition.onresult = (event)=>{
      let finalAgg = '';
      for(let i=0;i<event.results.length;i++){
        const res = event.results[i];
        if(res.isFinal) finalAgg += res[0].transcript + ' ';
      }
      if(finalAgg){
        const el = document.getElementById('userAnswer');
        if(el){
          const prev = el.innerText.trim();
          if(!prev || prev === 'ë‹µë³€ë…¹ìŒì¤‘.....:'){
            el.innerText = finalAgg.trim();
          }
        }
      }
    };
    __recognition.onerror = (e)=>{ console.warn('[STT]', e?.error || e); };
    __recognition.start();
    sttActive = true;
    return true;
  }
  function stopContinuousSTT(){
    if(__recognition){
      try{ __recognition.stop(); }catch(_){}
      __recognition=null;
    }
    sttActive = false;
  }

  (function patchOpenClose(){
    const _open = window.openQuestion;
    window.openQuestion = async function(idx){
      await _open(idx);
      const box = document.getElementById('userAnswer');
      if(box){ box.contentEditable = 'true'; box.setAttribute('placeholder','ì—¬ê¸°ì— ë‚´ ë‹µë³€ì´ ê¸°ë¡ë©ë‹ˆë‹¤. (ìˆ˜ì • ê°€ëŠ¥)'); }
      try{ await renderMicSelect(); }catch(e){ console.warn('ë§ˆì´í¬ ì¥ì¹˜ ì´ˆê¸°í™” ì‹¤íŒ¨', e); }
    };
    const _close = window.closeQuestion;
    window.closeQuestion = function(){
      stopContinuousSTT();
      stopMic();
      _close();
    };
  })();

  (function hookRecordAndSubmit(){
    const recBtn = document.getElementById('recordBtn');
    const submitBtn = document.getElementById('submitBtn');

    if(recBtn && !recBtn.__patched){
      recBtn.addEventListener('click', async ()=>{
        if(!micStream){
          try{ await renderMicSelect(); }catch(e){ alert('ë§ˆì´í¬ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (e?.message||e)); return; }
        }
        if(!sttActive){
          const ok = startContinuousSTT();
          if(!ok) return;
        }
        alert('ë…¹ìŒì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹µë³€ì„ ë§ì”€í•˜ì‹œê³ , ëë‚˜ë©´ "ë‹µë³€ì™„ë£Œ"ë¥¼ ëˆ„ë¥´ì„¸ìš”.');
      });
      recBtn.__patched = true;
    }

    if(submitBtn && !submitBtn.__patched){
      const origSubmit = submitBtn.onclick;
      submitBtn.onclick = async ()=>{
        stopContinuousSTT();
        if(mediaRecorder && mediaRecorder.state!=='inactive'){
          const stopped = new Promise(res=>{
            mediaRecorder.onstop = res;
            try{ mediaRecorder.stop(); }catch(_){}
          });
          await stopped;
        }

        const q = raw.find(x=>x._idx===currentIdx);
        if(q){
          const userEl = document.getElementById('userAnswer');
          const finalText = (userEl?.innerText || '').replace(/\s+/g,' ').trim();
          if(finalText && currentUser){
            q.answers = q.answers || [];
            const exists = q.answers.some(a =>
              (typeof a==='object' ? (a.text||'') : String(a||'')).trim() === finalText
            );
            const rec = {
              text: finalText,
              ownerUid: currentUser.uid,
              ownerName: currentUser.name || 'ì‚¬ìš©ì',
              createdAt: new Date().toISOString()
            };
            if(!exists) q.answers.push(rec);
            q.active = q.answers.length - 1;
            await persistQuestion(q);
            renderAnswerList();
          }
        }

        try{ typeof origSubmit==='function' && origSubmit(); }catch(_){}
      };
      submitBtn.__patched = true;
    }
  })();

  (function enableEditOwnAnswers(){
    const _render = window.renderAnswerList;
    window.renderAnswerList = function(){
      _render();
      const holder = document.getElementById('extraAnswers');
      if(!holder) return;
      const q = raw.find(x=>x._idx===currentIdx);
      if(!q) return;

      const radios = holder.querySelectorAll('input[name="ansPick"]');
      radios.forEach((r, i)=>{
        const wrap = r.parentElement;
        const ans = (q.answers||[])[i];
        const ownerUid = ans && typeof ans==='object' ? (ans.ownerUid||'') : '';
        const canEdit = currentUser && (currentUser.role==='admin' || (ownerUid && ownerUid===currentUser.uid));

        if(canEdit && !wrap.querySelector('[data-edit-ans]')){
          const editBtn = document.createElement('button');
          editBtn.className = 'btn';
          editBtn.textContent = 'âœï¸';
          editBtn.setAttribute('data-edit-ans', String(i));
          editBtn.style.marginLeft = '6px';
          editBtn.onclick = async ()=>{
            const curText = (typeof ans==='object' ? (ans.text||'') : String(ans||''));
            const nv = prompt('ì •ë‹µ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”', curText);
            if(nv && nv.trim()){
              if(typeof ans==='object'){ ans.text = nv.trim(); }
              else { q.answers[i] = { text: nv.trim(), ownerUid: ownerUid, ownerName: answerOwnerName(ans)||currentUser.name||'ì‚¬ìš©ì' }; }
              await persistQuestion(q);
              window.renderAnswerList();
            }
          };
          wrap.appendChild(editBtn);
        }
      });
    };
  })();
  </script>
  <!-- ================= [ì¶”ê°€ ë] ================= -->

  <!-- ================= [ì¶”ê°€] PWA ì„¤ì¹˜(ë°”íƒ•í™”ë©´ ì•„ì´ì½˜) ================= -->
  <script>
  (function setupPWAInstall(){
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js", { scope: "./" })
          .then(reg => console.log("[SW] registered:", reg.scope))
          .catch(err => console.warn("[SW] register failed:", err));
      });
    }

    let deferredPrompt = null;
    const LS_PWA_INSTALLED = "yj_pwa_installed_v1";
    const LS_PWA_PROMPTED  = "yj_pwa_prompted_v1";

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;

      const installed = window.matchMedia("(display-mode: standalone)").matches
                     || window.navigator.standalone === true
                     || localStorage.getItem(LS_PWA_INSTALLED) === "1";

      const prompted = localStorage.getItem(LS_PWA_PROMPTED) === "1";

      if (!installed && !prompted) {
        localStorage.setItem(LS_PWA_PROMPTED, "1");
        setTimeout(async () => {
          try{
            await deferredPrompt.prompt();
            const choice = await deferredPrompt.userChoice;
            if (choice && choice.outcome === "accepted") {
              console.log("[PWA] user accepted install");
            } else {
              console.log("[PWA] user dismissed install");
            }
          }catch(err){
            console.warn("[PWA] prompt failed:", err);
          }finally{
            deferredPrompt = null;
          }
        }, 1200);
      }
    });

    window.addEventListener("appinstalled", () => {
      localStorage.setItem(LS_PWA_INSTALLED, "1");
      console.log("[PWA] app installed");
    });

    function isIOS(){ return /iphone|ipad|ipod/i.test(navigator.userAgent); }
    function inStandalone(){ return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true; }
    function showIOSHintOnce(){
      const hinted = localStorage.getItem("yj_pwa_ios_hint_v1")==="1";
      if(hinted) return;
      if(isIOS() && !inStandalone()){
        localStorage.setItem("yj_pwa_ios_hint_v1","1");
        const tip = document.createElement("div");
        tip.textContent = "iOS: ê³µìœ (ìœ„ë¡œ í™”ì‚´í‘œ) â–¶ â€˜í™ˆ í™”ë©´ì— ì¶”ê°€â€™ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”.";
        tip.style.position="fixed";
        tip.style.left="50%";
        tip.style.bottom="16px";
        tip.style.transform="translateX(-50%)";
        tip.style.background="#15204a";
        tip.style.border="1px solid #2b3769";
        tip.style.color="#eaf0ff";
        tip.style.padding="10px 14px";
        tip.style.borderRadius="12px";
        tip.style.zIndex="9999";
        tip.style.boxShadow="0 8px 24px rgba(0,0,0,.35)";
        document.body.appendChild(tip);
        setTimeout(()=> tip.remove(), 6000);
      }
    }
    window.addEventListener("load", showIOSHintOnce);
  })();
  </script>
  <!-- ================= [ì¶”ê°€ ë] ================= -->

  <!-- ================= [ì¶”ê°€] ìë™ë¡œê·¸ì¸ ================= -->
  <script>
  (function autoLoginInit(){
    const LS_AUTO_ENABLED = "yj_auto_enabled_v1";
    const LS_AUTO_EMAIL   = "yj_auto_email_v1";
    const LS_AUTO_PASS    = "yj_auto_pass_v1";
    const LS_AUTO_TRIED   = "yj_auto_tried_once_v1";

    const autoChk = document.getElementById("autoLoginChk");
    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");

    function setInputsFromStorage(){
      try{
        const en = localStorage.getItem(LS_AUTO_ENABLED)==="1";
        if(autoChk) autoChk.checked = en;
        if(en){
          const em = localStorage.getItem(LS_AUTO_EMAIL)||"";
          const pw = localStorage.getItem(LS_AUTO_PASS)||"";
          if(emailEl && !emailEl.value) emailEl.value = em;
          if(passEl  && !passEl.value)  passEl.value  = pw;
        }
      }catch(_){}
    }

    function saveAutoCreds(email, pass){
      try{
        localStorage.setItem(LS_AUTO_ENABLED, autoChk && autoChk.checked ? "1":"0");
        if(autoChk && autoChk.checked){
          localStorage.setItem(LS_AUTO_EMAIL, email||"");
          localStorage.setItem(LS_AUTO_PASS,  pass||"");
        }else{
          localStorage.removeItem(LS_AUTO_EMAIL);
          localStorage.removeItem(LS_AUTO_PASS);
        }
      }catch(_){}
    }

    function clearTriedFlagSoon(){
      setTimeout(()=> localStorage.removeItem(LS_AUTO_TRIED), 1500);
    }

    setInputsFromStorage();

    (function patchLoginHandler(){
      const btn = document.getElementById("loginBtn");
      if(!btn) return;
      if(btn.__autopatched) return;

      const orig = btn.onclick;
      btn.onclick = async function(){
        const wantAuto = autoChk && autoChk.checked;
        const em = (emailEl?.value||"").trim();
        const pw = passEl?.value||"";

        let unsub = null;
        try{
          if(window.__cloudReady && window.__fb_api?.onAuthStateChanged){
            unsub = window.__fb_api.onAuthStateChanged(window.__fb.auth, (u)=>{
              if(u){
                if(wantAuto) saveAutoCreds(em, pw);
                else saveAutoCreds("", "");
                if(typeof unsub==="function") unsub();
              }
            });
          }
        }catch(_){}

        try{ await orig?.(); }catch(e){}

        clearTriedFlagSoon();
      };
      btn.__autopatched = true;
    })();

    (async function tryAutoOnce(){
      try{
        if(!window.__cloudReady) return;
        const enabled = localStorage.getItem(LS_AUTO_ENABLED)==="1";
        const tried   = localStorage.getItem(LS_AUTO_TRIED)==="1";
        const em      = localStorage.getItem(LS_AUTO_EMAIL)||"";
        const pw      = localStorage.getItem(LS_AUTO_PASS)||"";

        if(!enabled || tried || !em || !pw) return;

        localStorage.setItem(LS_AUTO_TRIED, "1");

        if(emailEl && !emailEl.value) emailEl.value = em;
        if(passEl  && !passEl.value)  passEl.value  = pw;

        const { signInWithEmailAndPassword } = window.__fb_api || {};
        if(typeof signInWithEmailAndPassword === "function"){
          await signInWithEmailAndPassword(window.__fb.auth, em, pw);
        }
        clearTriedFlagSoon();
      }catch(e){
        localStorage.removeItem(LS_AUTO_TRIED);
        console.warn("[AUTO-LOGIN] failed", e?.code || e);
      }
    })();

    if(autoChk && !autoChk.__bound){
      autoChk.addEventListener("change", ()=>{
        if(!autoChk.checked){
          saveAutoCreds("", "");
        }else{
          try{ localStorage.setItem(LS_AUTO_ENABLED, "1"); }catch(_){}
        }
      });
      autoChk.__bound = true;
    }
  })();
  </script>
  <!-- ================= [ì¶”ê°€ ë] ================= -->
  <script>
/* ===================== í•­ìƒ ë§ˆì§€ë§‰ ì‚¬ìš©ìë¡œ ìë™ë¡œê·¸ì¸ (í•„ìš” ì‹œ 1íšŒ ì¼ì‹œì •ì§€) ===================== */
(function alwaysAutoLogin(){
  const LS_AUTO_EMAIL   = "yj_auto_email_v1";
  const LS_AUTO_PASS    = "yj_auto_pass_v1";
  const LS_AUTO_ENABLED = "yj_auto_enabled_v1";      // í•­ìƒ '1'ë¡œ ìœ ì§€
  const LS_AUTO_PAUSE   = "yj_auto_suspend_once_v1"; // ë¡œê·¸ì•„ì›ƒ ì§í›„ 1íšŒë§Œ ìë™ë¡œê·¸ì¸ ê±´ë„ˆë›°ê¸°

  // 0) í•­ìƒ ìë™ë¡œê·¸ì¸ í™œì„±í™”ë¡œ í‘œì¤€í™”
  try { localStorage.setItem(LS_AUTO_ENABLED, "1"); } catch(_) {}

  // 1) ë¡œê·¸ì¸ ë²„íŠ¼ ë˜í•‘: ì„±ê³µí•˜ë©´ ë§ˆì§€ë§‰ ìê²©ì„ í•­ìƒ ì €ì¥
  (function patchLogin(){
    const btn = document.getElementById("loginBtn");
    if(!btn || btn.__alwaysAutoPatched) return;
    const orig = btn.onclick;
    btn.onclick = async function(){
      const emailEl = document.getElementById("email");
      const passEl  = document.getElementById("password");
      const em = (emailEl?.value||"").trim();
      const pw = passEl?.value||"";

      let unsub = null;
      try{
        if(window.__cloudReady && window.__fb_api?.onAuthStateChanged){
          unsub = window.__fb_api.onAuthStateChanged(window.__fb.auth, (u)=>{
            if(u){ // ë¡œê·¸ì¸ ì„±ê³µ â†’ í•­ìƒ ì €ì¥
              try{
                localStorage.setItem(LS_AUTO_EMAIL, em||"");
                localStorage.setItem(LS_AUTO_PASS, pw||"");
                localStorage.setItem(LS_AUTO_ENABLED, "1");
                localStorage.removeItem(LS_AUTO_PAUSE); // ì •ìƒí™”
              }catch(_){}
              if(typeof unsub==="function") unsub();
            }
          });
        }
      }catch(_){}
      try{ await orig?.(); }catch(_){}
    };
    btn.__alwaysAutoPatched = true;
  })();

  // 2) ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë˜í•‘: ì´ë²ˆ 1íšŒ ìë™ë¡œê·¸ì¸ë§Œ ì ê¹ ë©ˆì¶°ì„œ ê³„ì • ì „í™˜ ê°€ëŠ¥
  (function patchLogout(){
    const btn = document.getElementById("logoutBtn");
    if(!btn || btn.__alwaysAutoPatched) return;
    const orig = btn.onclick;
    btn.onclick = async function(){
      try{ localStorage.setItem(LS_AUTO_PAUSE, "1"); }catch(_){}
      try{ await orig?.(); }catch(_){}
    };
    btn.__alwaysAutoPatched = true;
  })();

  // 3) í˜ì´ì§€ ì§„ì… ì‹œ: ì¼ì‹œì •ì§€ í”Œë˜ê·¸ê°€ ì—†ê³ , ì €ì¥ëœ ìê²©ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ìë™ë¡œê·¸ì¸
  window.addEventListener("load", async ()=>{
    try{
      if(!window.__cloudReady) return;
      const paused  = localStorage.getItem(LS_AUTO_PAUSE) === "1";
      const enabled = localStorage.getItem(LS_AUTO_ENABLED) === "1";
      const em = localStorage.getItem(LS_AUTO_EMAIL) || "";
      const pw = localStorage.getItem(LS_AUTO_PASS)  || "";
      if(paused) { localStorage.removeItem(LS_AUTO_PAUSE); return; } // ì´ë²ˆ í•œ ë²ˆë§Œ ìŠ¤í‚µ
      if(!enabled || !em || !pw) return;
      const { signInWithEmailAndPassword } = window.__fb_api || {};
      if(typeof signInWithEmailAndPassword === "function"){
        await signInWithEmailAndPassword(window.__fb.auth, em, pw);
      }
    }catch(e){
      console.warn("[ALWAYS-AUTOLOGIN] failed:", e?.code || e);
    }
  });

  // 4) (ì„ íƒ) ì…ë ¥ì¹¸ ìë™ì±„ì›€ ë°©ì§€: í¼ì€ í•­ìƒ ë¹ˆ ìƒíƒœë¡œ ë³´ì´ê²Œ
  (function keepInputsEmptyOnce(){
    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    try{
      if(emailEl) emailEl.value = "";
      if(passEl)  passEl.value  = "";
      setTimeout(()=>{ try{
        if(emailEl) emailEl.value = "";
        if(passEl)  passEl.value  = "";
      }catch(_){} }, 150);
    }catch(_){}
  })();
})();
</script>

<script>
/* ======= ë…¹ìŒëœ ë‹µë³€ì˜ í¸ì§‘ UIë¥¼ 'ì¶”ê°€ì„¤ëª…' ìŠ¤íƒ€ì¼ textareaë¡œ ë°”ê¾¸ëŠ” ì˜¤ë²„ë¼ì´ë“œ ======= */
(function setupFreeformAnswerEditor(){
  // 1) í¸ì§‘ìš© textarea ìƒì„±(ì¶”ê°€ì„¤ëª…ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼), ê¸°ì¡´ #userAnswerëŠ” ìˆ¨ê¹€(í˜¸í™˜ì„ ìœ„í•´ ë‚¨ê¹€)
  function ensureEditor(){
    const ua = document.getElementById('userAnswer');
    if (ua) ua.style.display = 'none'; // ê¸°ì¡´ ë°•ìŠ¤ëŠ” ìˆ¨ê¹€

    let ed = document.getElementById('userAnswerEdit');
    if (!ed){
      const wrap = document.createElement('div');
      wrap.id = 'userAnswerEditWrap';
      const ta = document.createElement('textarea');
      ta.id = 'userAnswerEdit';
      ta.rows = 5;
      ta.placeholder = 'ì—¬ê¸°ì— ë‚´ ë‹µë³€ì´ ììœ ë¡­ê²Œ ê¸°ë¡ë©ë‹ˆë‹¤. (ë…¹ìŒ í›„ ìë™ ì±„ì›Œì§, ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)';
      // ì¶”ê°€ì„¤ëª…ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼(ê¸°ì¡´ CSSì™€ ì¶©ëŒ ì—†ë„ë¡ inline ì§€ì •)
      ta.style.width = '100%';
      ta.style.background = '#0b1330';
      ta.style.color = 'var(--ink)';
      ta.style.border = '1px solid #212c5c';
      ta.style.borderRadius = '14px';
      ta.style.padding = '8px';
      ta.style.resize = 'vertical';
      ta.style.minHeight = '80px';
      ta.style.fontSize = '14px';
      wrap.appendChild(ta);

      // ì €ì¥ ë²„íŠ¼(ì‚¬ìš©ì ë‹µë³€ì„ ì •ë‹µëª©ë¡ì— ì‚½ì…)
      const saveBtn = document.createElement('button');
      saveBtn.id = 'saveEditedBtn';
      saveBtn.className = 'btn ok';
      saveBtn.textContent = 'ğŸ’¾ ì‚¬ìš©ì ë‹µë³€ ì €ì¥';
      saveBtn.style.marginTop = '8px';
      wrap.appendChild(saveBtn);

      // ì‚½ì… ìœ„ì¹˜: ê¸°ì¡´ userAnswer ë°•ìŠ¤ê°€ ë“¤ì–´ìˆë˜ ìë¦¬(#userAnswer ë¶€ëª¨ ë‹¤ìŒ)ì— ë‘ 
      const uaParent = ua ? ua.parentElement : document.querySelector('#result') || document.body;
      uaParent.insertAdjacentElement('afterend', wrap);

      // í´ë¦­ ì‹œ ì €ì¥ â†’ ì •ë‹µëª©ë¡ì— ì¶”ê°€(ë’¤ì— ì‚¬ìš©ì ì´ë¦„ ë¶™ì„), ì´í›„ì—ë„ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥(ê¸°ì¡´ ê¶Œí•œ ë¡œì§ ì‚¬ìš©)
      saveBtn.addEventListener('click', async ()=>{
        try{
          const edVal = (document.getElementById('userAnswerEdit')?.value || '').replace(/\s+/g,' ').trim();
          if (!edVal){ alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
          if (!window.currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
          const userName = window.currentUser?.name || 'ì‚¬ìš©ì';
          const finalText = `${edVal} â€” ${userName}`;

          const q = window.raw.find(x=> x._idx === window.currentIdx);
          if (!q){ alert('ë¬¸í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
          q.answers = q.answers || [];

          const exists = q.answers.some(a => {
            const t = (typeof a==='object' ? (a.text||'') : String(a||'')).trim();
            return t === finalText;
          });
          if (!exists){
            q.answers.push({
              text: finalText,
              ownerUid: window.currentUser.uid,
              ownerName: userName,
              createdAt: new Date().toISOString()
            });
            q.active = q.answers.length - 1; // ë°©ê¸ˆ ì¶”ê°€í•œ ê²ƒì„ í™œì„± ì •ë‹µìœ¼ë¡œ
            await window.persistQuestion(q);
            window.renderAnswerList(); // âœï¸/ğŸ—‘ í¬í•¨ ëª©ë¡ ê°±ì‹ 
            alert('ì‚¬ìš©ì ë‹µë³€ì„ ì •ë‹µëª©ë¡ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
          }else{
            alert('ì´ë¯¸ ë™ì¼í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
          }
        }catch(e){
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (e?.message||e));
        }
      });
    }
  }

  // 2) STT: ë…¹ìŒ ì‹œì‘ ì‹œ textareaëŠ” ì ì‹œ ì•ˆë‚´ ë¬¸êµ¬ë§Œ, í¸ì§‘ ë¹„í™œì„±í™”
  function lockEditorForRecording(){
    const ed = document.getElementById('userAnswerEdit');
    if (ed){
      ed.disabled = true;
      ed.value = 'ë…¹ìŒ ì¤‘ì…ë‹ˆë‹¤â€¦ â€œë‹µë³€ì™„ë£Œâ€ë¥¼ ëˆ„ë¥´ë©´ ì—¬ê¸°ë¡œ ì „ì‚¬ëœ í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ì˜µë‹ˆë‹¤.';
    }
  }
  // 3) STT: ë‹µë³€ì™„ë£Œ ì‹œ ìµœì¢… í…ìŠ¤íŠ¸ë¥¼ textareaì— 1íšŒë§Œ ì¶œë ¥í•˜ê³ , í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ
  function fillEditorWithFinalText(text){
    const ed = document.getElementById('userAnswerEdit');
    if (ed){
      ed.disabled = false;
      ed.value = (text||'').replace(/\s+/g,' ').trim();
      ed.focus();
      ed.setSelectionRange(ed.value.length, ed.value.length);
    }
  }

  // 4) ê¸°ì¡´ ì˜¤ë²„ë¼ì´ë“œ/í•µì‹¬ ë²„íŠ¼ íë¦„ì— ë¼ì›Œ ë„£ê¸° (ê¸°ì¡´ ê¸°ëŠ¥ì€ ìœ ì§€)
  //    - recordBtn: STT ì‹œì‘(ìµœì¢…ë§Œ ë²„í¼ë§), textarea ì ê¸ˆ
  //    - submitBtn: STT ì¢…ë£Œ â†’ textareaì— ìµœì¢… í…ìŠ¤íŠ¸ 1íšŒ ì¶œë ¥ â†’ ì±„ì  í‘œì‹œ(ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ)
  (function wireButtons(){
    ensureEditor();

    // ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ìµœì¢… ë²„í¼(ì´ë¯¸ ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ì— __sttBufferê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ í™œìš©)
    if (typeof window.__sttBuffer === 'undefined') window.__sttBuffer = '';

    // ìš°ë¦¬ STT ìŠ¤íƒ€í„°(ìµœì¢…ë§Œ ëª¨ìŒ). ê¸°ì¡´ì— ì •ì˜ë¼ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©.
    function startFinalOnlySTT(){
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!window.SpeechRecognition){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return false; }
      if (window.__recognition){ try{ window.__recognition.stop(); }catch(_){}
        window.__recognition = null;
      }
      const rec = new window.SpeechRecognition();
      window.__recognition = rec;
      rec.lang = 'ko-KR';
      rec.continuous = true;
      rec.interimResults = true;
      window.__sttBuffer = '';

      rec.onresult = (ev)=>{
        for (let i = ev.resultIndex; i < ev.results.length; i++){
          const r = ev.results[i];
          if (r.isFinal) window.__sttBuffer += (r[0].transcript || '') + ' ';
        }
      };
      rec.onerror = (e)=> console.warn('[STT]', e?.error || e);
      try{ rec.start(); }catch(_){}
      return true;
    }
    function stopSTT(){
      if (window.__recognition){
        try{ window.__recognition.stop(); }catch(_){}
        window.__recognition = null;
      }
    }

    // recordBtn
    const recBtn = document.getElementById('recordBtn');
    if (recBtn && !recBtn.__freeformPatched){
      recBtn.addEventListener('click', ()=>{
        ensureEditor();
        lockEditorForRecording();
        startFinalOnlySTT();
        alert('ë…¹ìŒì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ë§ì”€ì„ ë§ˆì¹˜ë©´ "ë‹µë³€ì™„ë£Œ"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      });
      recBtn.__freeformPatched = true;
    }

    // submitBtn
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn && !submitBtn.__freeformPatched){
      const orig = submitBtn.onclick; // ê¸°ì¡´ ì±„ì  ë¡œì§ ë³´ì¡´
      submitBtn.onclick = async ()=>{
        stopSTT();
        // MediaRecorderê°€ ì¼œì ¸ ìˆë‹¤ë©´ ì •ì§€(ë¬´ì‹œí•´ë„ ë¬´ë°©)
        try{
          if (window.mediaRecorder && window.mediaRecorder.state!=='inactive'){
            const done = new Promise(res=>{
              window.mediaRecorder.onstop = res;
              try{ window.mediaRecorder.stop(); }catch(_){}
            });
            await done;
          }
        }catch(_){}
        // ìµœì¢… í…ìŠ¤íŠ¸ 1íšŒ ì¶œë ¥
        fillEditorWithFinalText(window.__sttBuffer || '');
        // ê¸°ì¡´ ì±„ì  ë¡œì§ ì‹¤í–‰(í™”ë©´ì— ìœ ì‚¬ë„ ë“± í‘œì‹œ)
        try{ typeof orig==='function' && orig(); }catch(_){}
      };
      submitBtn.__freeformPatched = true;
    }

    // ëª¨ë‹¬ ì—´ë¦´ ë•Œë§ˆë‹¤ ì—ë””í„° ì¤€ë¹„
    const _open = window.openQuestion;
    window.openQuestion = async function(idx){
      await _open(idx);
      ensureEditor();
      const ed = document.getElementById('userAnswerEdit');
      if (ed){ ed.disabled = false; ed.value = ''; }
    };
  })();
})();
</script>

<script>
/* ================== 'ë‹µë³€ë…¹ìŒ â†’ ë‹µë³€ì™„ë£Œ' ì „ êµ¬ê°„ ì™„ì „ ë…¹ìŒ ì˜¤ë²„ë¼ì´ë“œ ================== */
/* ëª©ì : ë‹µë³€ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ë§ˆì´í¬ ìº¡ì²˜ì™€ MediaRecorderë¥¼ ì‹œì‘í•˜ê³ ,
         ë‹µë³€ì™„ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥´ëŠ” ìˆœê°„ê¹Œì§€ ì „ êµ¬ê°„ì„ 100% ë…¹ìŒí•œë‹¤. (STTëŠ” ê¸°ì¡´ íë¦„ ê·¸ëŒ€ë¡œ) */

(function perfectRecordingBetweenButtons(){
  // ë‚´ë¶€ ìƒíƒœ
  let recStream = null;          // MediaStream
  let recorder  = null;          // MediaRecorder
  let recChunks = [];            // Blob íŒŒí¸
  let recStopWaiter = null;      // stop ì™„ë£Œ ëŒ€ê¸° Promise
  let isRecording = false;       // ì§„í–‰ í”Œë˜ê·¸

  // ê¸°ì¡´ì— ì—´ë ¤ìˆëŠ” ìŠ¤íŠ¸ë¦¼/ë ˆì½”ë”ë¥¼ ëª¨ë‘ ì¢…ë£Œ
  async function cleanupRecording(){
    try{
      if(recorder && recorder.state !== 'inactive'){
        await stopRecorder(); // ì•ˆì „ ì •ì§€
      }
    }catch(_){}
    if(recStream){
      try{ recStream.getTracks().forEach(t=>t.stop()); }catch(_){}
    }
    recStream = null;
    recorder  = null;
    recChunks = [];
    recStopWaiter = null;
    isRecording = false;
  }

  // ë§ˆì´í¬ ì‹œì‘ + MediaRecorder ì‹œì‘
  async function startRecorder(){
    await cleanupRecording();

    // ì„ í˜¸ ë””ë°”ì´ìŠ¤ ì„ íƒ(ìˆìœ¼ë©´), ì—†ìœ¼ë©´ ê¸°ë³¸
    let deviceId = null;
    try{
      const sel = document.getElementById('micSelect');
      deviceId = sel && sel.value ? sel.value : null;
    }catch(_){}

    // OBS/Zoom ìœ ì‚¬ ì˜µì…˜(ì—ì½”ì œê±°/ë…¸ì´ì¦ˆì–µì œ/AGC)
    const constraints = {
      audio: {
        deviceId: deviceId ? { exact: deviceId } : undefined,
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true,
        channelCount: 1,
        sampleRate: 48000
      }
    };

    recStream = await navigator.mediaDevices.getUserMedia(constraints);

    // mimeType í˜¸í™˜ ì²˜ë¦¬
    const mimeCandidates = [
      'audio/webm;codecs=opus',
      'audio/webm',
      'audio/ogg;codecs=opus',
      ''
    ];
    let mime = '';
    for(const m of mimeCandidates){
      if(!m || MediaRecorder.isTypeSupported(m)){ mime = m; break; }
    }

    recorder  = mime ? new MediaRecorder(recStream, { mimeType: mime }) : new MediaRecorder(recStream);
    recChunks = [];

    recorder.ondataavailable = (e)=>{
      if(e.data && e.data.size > 0) recChunks.push(e.data);
    };
    recStopWaiter = new Promise(res=>{
      recorder.onstop = ()=> res();
    });

    // íƒ€ì„ìŠ¬ë¼ì´ìŠ¤ ì—†ì´ ì—°ì† ë…¹ìŒ(ì „ì²´ë¥¼ ì˜¨ì „íˆ ë³´ì¡´)
    recorder.start();
    isRecording = true;
  }

  // MediaRecorder ì •ì§€ ë° Blob ë°˜í™˜
  async function stopRecorder(){
    if(!recorder) return null;
    const local = recStopWaiter;
    if(recorder.state !== 'inactive'){
      try{ recorder.stop(); }catch(_){}
      try{ await local; }catch(_){}
    }
    const mime = recorder.mimeType || 'audio/webm';
    const blob = new Blob(recChunks, { type: mime });
    isRecording = false;
    return blob;
  }

  // ë²„íŠ¼ ì—°ê²°: ë‹µë³€ë…¹ìŒ â†’ start, ë‹µë³€ì™„ë£Œ â†’ stop
  function wireButtons(){
    const recBtn    = document.getElementById('recordBtn');
    const submitBtn = document.getElementById('submitBtn');

    if(recBtn && !recBtn.__perfectRec){
      recBtn.addEventListener('click', async ()=>{
        try{
          await startRecorder();             // â˜… ì—¬ê¸°ì„œë¶€í„° ë…¹ìŒ ì‹œì‘
          // (ì°¸ê³ ) STTëŠ” ê¸°ì¡´/ì˜¤ë²„ë ˆì´ ìŠ¤í¬ë¦½íŠ¸ê°€ ì•Œì•„ì„œ ë™ì‘í•˜ë¯€ë¡œ ì¶”ê°€ ì¡°ì‘ ì—†ìŒ
        }catch(e){
          alert('ë§ˆì´í¬ ë…¹ìŒì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (e?.message || e));
        }
      });
      recBtn.__perfectRec = true;
    }

    if(submitBtn && !submitBtn.__perfectRec){
      const orig = submitBtn.onclick; // ê¸°ì¡´ ì±„ì /í‘œì‹œ ë¡œì§ ë³´ì¡´
      submitBtn.onclick = async ()=>{
        // â˜… ì—¬ê¸°ê¹Œì§€ì˜ ì „ì²´ ì˜¤ë””ì˜¤ë¥¼ í™•ë³´
        let blob = null;
        try{
          if(isRecording){
            blob = await stopRecorder();
          }
        }catch(_){}

        // ì›í•œë‹¤ë©´ blobì„ ì–´ë”˜ê°€ì—ì„œ í™œìš©í•  ìˆ˜ ìˆë„ë¡ ë…¸ì¶œ(ìš”ì²­ì‚¬í•­ì—” ì €ì¥/ì¬ìƒ ìš”êµ¬ ì—†ìŒ)
        // ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ê°€ í•„ìš” ì‹œ ì ‘ê·¼ ê°€ëŠ¥
        window.__lastAnswerAudioBlob = blob || null;

        // ë‚˜ë¨¸ì§€ ê¸°ì¡´ ë™ì‘(ì „ì‚¬ ì¶œë ¥/ì±„ì  ë“±)ì€ ê·¸ëŒ€ë¡œ
        try{ typeof orig === 'function' && orig(); }catch(_){}
      };
      submitBtn.__perfectRec = true;
    }
  }

  // ëª¨ë‹¬ ë‹«í˜/ì—´ë¦¼ ì‹œ ìƒíƒœ ì •ë¦¬
  (function hookDialogLifecycle(){
    const _open = window.openQuestion;
    window.openQuestion = async function(idx){
      await _open(idx);
      // ìƒˆ ì§ˆë¬¸ ë“¤ì–´ê°ˆ ë•Œ ì´ì „ ë…¹ìŒ ì •ë¦¬
      await cleanupRecording();
      wireButtons();
    };
    const _close = window.closeQuestion;
    window.closeQuestion = function(){
      cleanupRecording();
      _close();
    };
  })();

  // ì´ˆê¸° ë°”ì¸ë”©(í˜ì´ì§€ ì´ë¯¸ ì—´ë ¤ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 1íšŒ ì‹œë„)
  window.addEventListener('load', wireButtons);
})();
</script>

<script>
/* ====== "ì‚¬ìš©ì ë‹µë³€ ì €ì¥" â†’ "ì •ë‹µëª©ë¡ì— ì €ì¥" & ì €ì¥ ë™ì‘: ì „ì‚¬ í…ìŠ¤íŠ¸ë¥¼ ì •ë‹µëª©ë¡ì— ì¶”ê°€ ====== */
(function patchSaveToAnswerList(){
  // ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ë§Œë“¤ì–´ì§€ê¸°ë„ í•˜ë¯€ë¡œ, ë‚˜íƒ€ë‚˜ëŠ” ì¦‰ì‹œ íŒ¨ì¹˜
  function tryPatch(btn){
    if (!btn || btn.__patchedSaveToList) return;
    // 1) ë¼ë²¨ êµì²´
    btn.textContent = 'ğŸ“š ì •ë‹µëª©ë¡ì— ì €ì¥';

    // 2) ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°(í´ë¡  êµì²´) í›„, ìš°ë¦¬ê°€ ì›í•˜ëŠ” ë™ì‘ìœ¼ë¡œ ì¬ë°”ì¸ë”©
    const clone = btn.cloneNode(true);
    btn.replaceWith(clone);

    clone.addEventListener('click', async ()=>{
      try{
        // ì „ì‚¬ëœ í…ìŠ¤íŠ¸ ìš°ì„ ìˆœìœ„: ììœ í¸ì§‘ textarea â†’ ê¸°ì¡´ userAnswer ë°•ìŠ¤
        const ta = document.getElementById('userAnswerEdit');
        const ua = document.getElementById('userAnswer');
        const rawText = (ta && !ta.disabled ? ta.value : (ua ? ua.innerText : '')) || '';
        const text = rawText.replace(/\s+/g,' ').trim();
        if (!text){ alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
        if (!window.currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }

        const userName = window.currentUser?.name || 'ì‚¬ìš©ì';
        const finalText = `${text} â€” ${userName}`;

        const q = (window.raw||[]).find(x=> x._idx === window.currentIdx);
        if (!q){ alert('ë¬¸í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        q.answers = q.answers || [];

        // ë™ì¼ ë¬¸ì¥ ì¤‘ë³µ ë°©ì§€
        const exists = q.answers.some(a=>{
          const t = (typeof a==='object' ? (a.text||'') : String(a||'')).trim();
          return t === finalText;
        });
        if (exists){
          alert('ì´ë¯¸ ë™ì¼í•œ ë‚´ìš©ì´ ì •ë‹µëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.');
          return;
        }

        q.answers.push({
          text: finalText,
          ownerUid: window.currentUser.uid,
          ownerName: userName,
          createdAt: new Date().toISOString()
        });
        q.active = q.answers.length - 1; // ë°©ê¸ˆ ì¶”ê°€í•œ í•­ëª©ì„ í™œì„± ì •ë‹µìœ¼ë¡œ
        await window.persistQuestion(q);
        if (typeof window.renderAnswerList === 'function') window.renderAnswerList();
        alert('ì •ë‹µëª©ë¡ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
      }catch(e){
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (e?.message||e));
      }
    });

    clone.__patchedSaveToList = true;
  }

  function scanOnce(){
    const btn = document.getElementById('saveEditedBtn');
    if (btn) tryPatch(btn);
  }

  // ì´ˆê¸° ì‹œë„
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', scanOnce);
  } else {
    scanOnce();
  }

  // ë™ì  ìƒì„± ëŒ€ì‘
  const mo = new MutationObserver((muts)=>{
    for (const m of muts){
      for (const n of m.addedNodes){
        if (n.nodeType === 1){
          if (n.id === 'saveEditedBtn') tryPatch(n);
          const cand = n.querySelector && n.querySelector('#saveEditedBtn');
          if (cand) tryPatch(cand);
        }
      }
    }
  });
  mo.observe(document.body, { childList: true, subtree: true });
})();
</script>

</body>
</html>
