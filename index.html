<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icons" href="youth_icon_192.png" type="image/png">
  <link rel="apple-touch-icon" href="youth_icon_512.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10183a">
  <title>ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ì—°ìŠµ ì‹œìŠ¤í…œ</title>
  <style>
    :root{ --bg:#0b1020; --panel:#10183a; --ink:#eaf0ff; --muted:#a7b3d4; --brand:#6aa6ff; --accent:#a176ff; --ok:#4cd97b; --danger:#ff6a6a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Noto Sans KR,Segoe UI,Roboto,sans-serif;color:var(--ink);background:radial-gradient(1200px 800px at 80% -10%,#1a2650 0%,#0b1020 45%)}
    header{padding:18px 20px 10px;display:flex;gap:10px;align-items:center}
    .spacer{flex:1}
    header h1{margin:0;font-size:18px}
    .pill{border:1px solid #28376e;border-radius:999px;color:var(--muted);padding:6px 10px;font-size:12px}

    .wrap{max-width:1200px;margin:0 auto;padding:10px 16px 40px}
    .panel{border:1px solid #263062;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:10px;align-items:center;padding:14px;border-bottom:1px solid #283162;flex-wrap:wrap}
    .toolbar .btn{border:1px solid #2b3769;background:#16214a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .toolbar .btn:hover{background:#1a2a56}
    .toolbar .stat{color:var(--muted);font-size:13px}
    .toolbar select{border:1px solid #2b3769;background:#0f1633;color:var(--ink);padding:8px 10px;border-radius:10px;min-width:220px}
    .counts{display:flex;gap:12px;align-items:center}
    .counts .pill{border-color:#2b3769}

    .grid{display:grid;gap:6px;padding:10px;grid-template-columns:1fr}
    .qbtn{display:block;width:100%;text-align:left;background:#0f1633;border:1px solid #1f2a5a;border-radius:12px;color:var(--ink);padding:8px 10px;margin:2px 0;cursor:pointer;font-size:14px;line-height:1.28}
    .qbtn:hover{background:#121b3e}

    dialog{width:min(920px,96vw);background:#0c122a;border:1px solid #243064;border-radius:16px;color:var(--ink)}
    dialog::backdrop{background:rgba(0,10,30,.6);backdrop-filter:blur(3px)}
    .dlg{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #304080;background:#15204a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#1f3d92,#1a2c6d);border-color:#2f47a8}
    .btn.ok{background:#123b2a;border-color:#0d5b3a}
    .btn.danger{background:#3a1330;border-color:#7a244f}
    .answer-box{background:#0b1330;border:1px solid #212c5c;border-radius:14px;padding:12px;min-height:56px;white-space:pre-wrap}
    textarea{width:100%;background:#0b1330;color:var(--ink);border:1px solid #212c5c;border-radius:14px;padding:8px;resize:vertical;min-height:80px;font-size:14px;}

    .login-card{width:min(480px,92vw);margin:0 auto}

    #extraInfo { max-height:50vh; overflow:auto; resize:vertical; }
    .score{font-size:36px;font-weight:800}
    .answer-box, #extraInfo { font-size:14px; } 

    .blink{animation: blink 1s step-start 0s infinite}
    @keyframes blink{ 50%{ opacity: .2 } }

    /* ======== [ì¶”ê°€] ëª¨ë°”ì¼ ìµœì í™” & í™•ëŒ€ ìŠ¤ì¼€ì¼ ======== */
    :root { --scale: 1; }                         /* ê¸€ì/ë²„íŠ¼ ì „ì²´ í™•ëŒ€ ë°°ìœ¨ */
    body { font-size: calc(16px * var(--scale)); }/* ê¸°ë³¸ ê¸€ê¼´ í¬ê¸° í™•ëŒ€ */
    .qbtn { 
      font-size: calc(14px * var(--scale)); 
      padding: calc(10px * var(--scale)) 12px; 
      min-height: 44px;                           /* í„°ì¹˜ í‘œì¤€ */
    }
    .btn { min-height: 40px; }

    @media (max-width: 480px){
      header{ padding:12px 12px 6px }
      header h1{ font-size: clamp(16px, 5vw, 18px) }
      .wrap{ padding:8px 10px 24px }
      .toolbar{ gap:6px; padding:10px; }
      .toolbar .btn, .btn{ padding:12px 14px; min-height:44px; }
      .counts .pill{ display:none; }              /* ìƒë‹¨ ê³µê°„ ì ˆì•½ */

      .grid{ gap:8px; padding:8px; grid-template-columns: 1fr; }
      .qbtn{ font-size: clamp(14px, 4vw, 16px); padding:12px 14px; }

      /* ëª¨ë‹¬ì„ ëª¨ë°”ì¼ í’€ìŠ¤í¬ë¦° */
      dialog{ width:100vw; height:100dvh; max-width:none; border-radius:0; }
      .dlg{ height:100%; overflow:auto; padding:12px; }
      #extraInfo{ min-height:120px; }
    }
    /* ======== [ì¶”ê°€ ë] ======== */
  </style>

  <!-- Firebase SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8uvt7bkZokVkHT7nO0QRaB9WpEe2g2C4",
      authDomain: "youth-worker.firebaseapp.com",
      projectId: "youth-worker",
      storageBucket: "youth-worker.firebasestorage.app",
      messagingSenderId: "666890915384",
      appId: "1:666890915384:web:90381989a786934648a0cd",
      measurementId: "G-T1NCJXS15N"
    };

    try{
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      const auth = getAuth(app);

      window.__cloudReady = true;
      window.__fb = {
        app, db, auth,
        colShared : () => collection(db, "sharedData"),
        colProgress: () => collection(db, "progress"),
        colUsers   : () => collection(db, "users")
      };
      window.__fb_api = {
        getDoc, getDocs, setDoc, doc, deleteDoc, writeBatch,
        onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile
      };
      console.log('[firebase] initialized');
    }catch(e){
      console.warn('[firebase] init failed -> local fallback', e);
      window.__cloudReady = false;
    }
  </script>

  <!-- íŒŒì´ì–´ë² ì´ìŠ¤ ì‹¤íŒ¨ ì‹œ ì „ì—­ í´ë°± (UIëŠ” ê³„ì† ë™ì‘) -->
  <script>
    window.__cloudReady = window.__cloudReady || false;
    window.__fb       = window.__fb       || { db:null, auth:null, colShared:()=>({}), colProgress:()=>({}), colUsers:()=>({}) };
    window.__fb_api   = window.__fb_api   || {};
    window.__fb_api.getDocs   = window.__fb_api.getDocs   || (async ()=>({ forEach:()=>{} }));
    window.__fb_api.setDoc    = window.__fb_api.setDoc    || (async ()=>{});
    window.__fb_api.doc       = window.__fb_api.doc       || (()=>({}));
    window.__fb_api.deleteDoc = window.__fb_api.deleteDoc || (async ()=>{});
    window.__fb_api.writeBatch= window.__fb_api.writeBatch|| (()=>({ set(){}, commit:async()=>{} }));
    window.__fb_api.onAuthStateChanged = window.__fb_api.onAuthStateChanged || (()=>{});
    window.__fb_api.signInWithEmailAndPassword = window.__fb_api.signInWithEmailAndPassword || (async ()=>{ throw new Error('auth disabled'); });
    window.__fb_api.createUserWithEmailAndPassword = window.__fb_api.createUserWithEmailAndPassword || (async ()=>{ throw new Error('auth disabled'); });
    window.__fb_api.signOut = window.__fb_api.signOut || (async ()=>{});
    window.__fb_api.updateProfile = window.__fb_api.updateProfile || (async ()=>{});
  </script>
</head>
<body>
  <header>
    <div class="pill">ì²­ì†Œë…„ì§€ë„ì‚¬ ë©´ì ‘ ëŒ€ë¹„</div>
    <h1>í•™ìŠµì‹œìŠ¤í…œ 6.0</h1>
    <div class="spacer"></div>
    <div id="headerRank" class="pill" style="display:none"></div>
    <div id="headerUser" class="pill" style="display:none"></div>
    <button id="logoutBtn" class="btn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
  </header>

  <div class="wrap">
    <!-- ë¡œê·¸ì¸ -->
    <div id="loginPanel" class="panel">
      <div class="login-card" style="padding:20px;display:flex;flex-direction:column;gap:12px">
        <h2>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
        <input id="email" type="email" placeholder="ì´ë©”ì¼" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <input id="displayName" placeholder="í‘œì‹œ ì´ë¦„ (ì²˜ìŒ 1íšŒë§Œ)" style="padding:8px;border-radius:6px;border:1px solid #2b3769;background:#0f1633;color:var(--ink)">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="loginBtn" class="btn primary">ë¡œê·¸ì¸</button>
          <button id="signupBtn" class="btn">íšŒì›ê°€ì…</button>
          <button id="resetPwBtn" class="btn">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>
        </div>
        <div id="envErr" style="font-size:12px;color:#ffb3b3;min-height:18px"></div>
        <div id="rankList" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ë©”ì¸ -->
    <div id="mainPanel" class="panel" style="display:none">
      <div class="toolbar">
        <button id="resetProgress" class="btn">ì´ˆê¸°í™”</button>
        <button id="zoomBtn" class="btn">ê¸€ì í¬ê²Œ</button><!-- [ì¶”ê°€] ê¸€ì í¬ê¸° í† ê¸€ -->
        <label for="subjectSelect" class="stat">ê³¼ëª© ì„ íƒ:</label>
        <select id="subjectSelect"></select>
        <div class="counts">
          <div class="pill" id="countTotal">ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ 0</div>
          <div class="pill" id="countLearned">ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ 0</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="addQuestionBtn" class="btn">ìƒˆ ì§ˆë¬¸ ì¶”ê°€</button>
          <button id="exportBtn" class="btn">ë‚´ë³´ë‚´ê¸°</button>
          <button id="importBtn" class="btn">ê°€ì ¸ì˜¤ê¸°</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <!-- ê´€ë¦¬ì ì „ìš© -->
          <button id="manageUsersBtn" class="btn" style="display:none">ì‚¬ìš©ì ê´€ë¦¬(ê´€ë¦¬ì)</button>
        </div>
      </div>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- ì§ˆë¬¸ ëª¨ë‹¬ -->
  <dialog id="qd">
    <div class="dlg">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h2 id="qTitle" style="margin:0"></h2>
        <div><button id="deleteQuestionBtn" class="btn danger">ğŸ—‘ ì§ˆë¬¸ ì‚­ì œ</button></div>
      </div>

      <div class="row">
        <button id="speakBtn" class="btn">ğŸ”Š ì§ˆë¬¸ ë‹¤ì‹œë“£ê¸°</button>

        <button id="recordBtn" class="btn">ğŸ¤ ë‹µë³€ë…¹ìŒ</button>
        <button id="submitBtn" class="btn primary">âœ… ë‹µë³€ì™„ë£Œ</button>
        <button id="addAnswerBtn" class="btn" style="display:none">â• ì •ë‹µ ì¶”ê°€</button>

        <!-- ìƒë‹¨ 'ì •ë‹µ ë“£ê¸°' ë²„íŠ¼ì€ ì œê±°ë¨ -->
        <button id="learnedBtn" class="btn ok">ğŸ“Œ ìŠµë“ì™„ë£Œ</button>
        <button id="closeBtn" class="btn danger">âŒ ë‹«ê¸°</button>
      </div>

      <div><div class="answer-box" id="userAnswer"></div></div>
      <div id="result"></div>

      <div id="extraAnswers"></div>

      <hr style="border:0;border-top:1px solid #1f2a55;margin:8px 0">
      <div>
        <h3>ì¶”ê°€ì„¤ëª…</h3>
        <textarea id="extraInfo" rows="5" placeholder="í•µì‹¬ ìš”ì , ë°°ê²½ì§€ì‹, ì˜ˆì‹œ ë“±ì„ ì ì–´ë‘ì„¸ìš”."></textarea>
        <button id="saveExtraInfoBtn" class="btn">ğŸ’¾ ì¶”ê°€ì„¤ëª… ì €ì¥</button>
        <button id="expandExtraInfoBtn" class="btn">ğŸ” ì „ì²´ë³´ê¸°</button>
        <button id="ttsExtraBtn" class="btn">ğŸ”Š ì¶”ê°€ì„¤ëª… ë“£ê¸°</button>
      </div>

      <div>
        <h3>ì¶”ê°€ì§ˆë¬¸ ë° ë‹µë³€</h3>
        <div id="followupsBox" class="answer-box" style="min-height:0"></div>
        <div class="row" style="align-items:flex-start">
          <textarea id="fuQ" rows="3" placeholder="ì¶”ê°€ì§ˆë¬¸"></textarea>
          <textarea id="fuA" rows="3" placeholder="ì¶”ê°€ë‹µë³€"></textarea>
          <button id="addFollowupBtn" class="btn">â• ì¶”ê°€ì§ˆë¬¸/ë‹µë³€ ì¶”ê°€</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- ìƒˆ ì§ˆë¬¸ ì¶”ê°€ ë‹¤ì´ì–¼ë¡œê·¸ -->
  <dialog id="addDlg">
    <div class="dlg">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h2 style="margin:0">ìƒˆ ì§ˆë¬¸ ì¶”ê°€</h2>
        <button id="addDlgClose" class="btn danger">ë‹«ê¸°</button>
      </div>
  
      <div class="pill" id="addDlgSubjectPill" style="margin-bottom:8px"></div>
  
      <div>
        <h3>ì§ˆë¬¸</h3>
        <textarea id="addQ" rows="3" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ì²­ì†Œë…„ ì •ì±…ì˜ 3ëŒ€ ì¶•ì€?"></textarea>
      </div>
  
      <div>
        <h3>ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)</h3>
        <div id="addAnswersBox" style="display:flex;flex-direction:column;gap:8px"></div>
        <div class="row">
          <button id="addAnsRowBtn" class="btn">â• ì •ë‹µ ì…ë ¥ì¹¸ ì¶”ê°€</button>
        </div>
        <div class="pill" style="margin-top:6px">ì²« ë²ˆì§¸ ì •ë‹µì´ ê¸°ë³¸ í™œì„± ì •ë‹µìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>
  
      <div>
        <h3>ì¶”ê°€ì„¤ëª…</h3>
        <textarea id="addExtra" rows="5" placeholder="í•µì‹¬ ìš”ì , ë°°ê²½ì§€ì‹, ì˜ˆì‹œ ë“±ì„ ì ì–´ë‘ì„¸ìš”."></textarea>
      </div>
  
      <div>
        <h3>ì¶”ê°€ì§ˆë¬¸ ë° ë‹µë³€</h3>
        <div id="addFollowupsBox" style="display:flex;flex-direction:column;gap:8px"></div>
        <div class="row">
          <button id="addFUrowBtn" class="btn">â• ì¶”ê°€ì§ˆë¬¸/ë‹µë³€ ì…ë ¥ì¹¸ ì¶”ê°€</button>
        </div>
      </div>
  
      <div class="row" style="justify-content:flex-end">
        <button id="addDlgSave" class="btn primary">âœ… ì €ì¥</button>
      </div>
    </div>
  </dialog>

  

  <!-- ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë‹¬(ê´€ë¦¬ì ì „ìš©) -->
  <dialog id="userMngDlg">
    <div class="dlg">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">ì‚¬ìš©ì ê´€ë¦¬</h2>
        <button id="userMngClose" class="btn danger">ë‹«ê¸°</button>
      </div>
      <div id="userMngList" style="display:flex;flex-direction:column;gap:8px"></div>
      <div class="pill" style="margin-top:8px">â€» ê´€ë¦¬ìëŠ” ëª©ë¡/ìˆœìœ„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</div>
    </div>
  </dialog>

  <script>
    /* ================= ê³µí†µ ìƒíƒœ/ìœ í‹¸ ================= */
    let raw = [];        // ì „ì²´ ë¬¸í•­(ê³µìœ )
    let data = [];       // ë¯¸ìŠµë“ë§Œ í‘œì‹œ
    let currentUser = null; // { uid, name, role }
    let currentIdx = null;
    let recognition = null;
    let recBlinkTimer = null;
    let recFinalOnly = '';  // ìµœì¢…ë§Œ ëª¨ì„ ë²„í¼

    const LS_SHARED = 'yj_shared_backup_v1';
    const LS_PROG   = 'yj_progress_backup_v1';
    const LS_LOCAL_OVR = 'yj_local_overrides_v1';

    const ADMIN_EMAILS = new Set([
      // í•„ìš” ì‹œ ê´€ë¦¬ì ì´ë©”ì¼ì„ ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš”. ì˜ˆ: 'admin@example.com'
    ]);

    const normSubj = s => {
      const v = (s??'').toString().trim();
      return v.length ? v : 'ê¸°íƒ€';
    };
    const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const qKey = q => `${normSubj(q.subject)}::${q.question}`;

    function showError(msg){
      const box = document.getElementById('envErr');
      if(box){ box.textContent = msg; }
      console.error('[APP]', msg);
    }

    function isAnswerObj(a){ return a && typeof a === 'object' && 'text' in a; }
    function answerText(a){ return isAnswerObj(a) ? a.text : String(a||''); }
    function answerOwnerName(a){ return isAnswerObj(a) ? (a.ownerName||'') : ''; }
    function answerOwnerUid(a){ return isAnswerObj(a) ? (a.ownerUid||'') : ''; }

    /* ================= ë¡œì»¬ í´ë°± ì €ì¥ì†Œ ================= */
    function lsGet(key, def){ try{ const v=localStorage.getItem(key); return v? JSON.parse(v): def; }catch{return def;} }
    function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    /* ====== ë¡œì»¬ ì˜¤ë²„ë ˆì´ í—¬í¼ ====== */
    function loadLocalOverrides(){
      return lsGet(LS_LOCAL_OVR, {});
    }
    function saveLocalOverride(id, patch){
      const ov = loadLocalOverrides();
      ov[id] = { ...(ov[id]||{}), ...patch };
      lsSet(LS_LOCAL_OVR, ov);
    }
    function deleteLocalOverride(id){
      const ov = loadLocalOverrides();
      delete ov[id];
      lsSet(LS_LOCAL_OVR, ov);
    }

    /* ================= Firestore ì§„ë‹¨ ================= */
    async function pingFirestore(){
      const box = document.getElementById('envErr');
      try{
        if(!window.__cloudReady){ box.textContent=''; return false; }
        const { getDocs } = window.__fb_api;
        await getDocs(window.__fb.colShared());
        box.textContent = '';
        return true;
      }catch(e){
        console.warn('[pingFirestore] Firestore unavailable (silent):', e?.code, e?.message);
        box.textContent = '';
        return false;
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>{ pingFirestore(); });

    /* ================= Users í—¬í¼ ================= */
    async function ensureUserProfile(user){
      try{
        if(!window.__cloudReady || !user) return;
        const { db } = window.__fb;
        const { doc, getDoc, setDoc, getDocs } = window.__fb_api;

        // users ë¹„ì–´ìˆìœ¼ë©´ ì²« ì‚¬ìš©ì admin
        let firstAdmin = false;
        try{
          const snapAll = await getDocs(window.__fb.colUsers());
          firstAdmin = snapAll.empty;
        }catch(_){}

        const ref = doc(db, 'users', user.uid);
        const snap = await getDoc(ref);
        const role = ADMIN_EMAILS.has(user.email) || firstAdmin ? 'admin' : 'user';
        if(!snap.exists()){
          await setDoc(ref, {
            uid:user.uid, email:user.email||'',
            displayName:user.displayName || (user.email? user.email.split('@')[0] : 'ì‚¬ìš©ì'),
            role, createdAt: new Date().toISOString()
          });
        }else{
          const d = snap.data()||{};
          const wantRole = ADMIN_EMAILS.has(user.email) ? 'admin' : (d.role||'user');
          if(d.role!==wantRole || d.displayName!==(user.displayName||d.displayName)){
            await setDoc(ref, { role: wantRole, displayName:user.displayName||d.displayName }, { merge:true });
          }
        }
      }catch(e){ console.warn('ensureUserProfile fail', e); }
    }
    async function loadUsersMap(){
      const map = new Map();
      try{
        if(!window.__cloudReady) return map;
        const { getDocs } = window.__fb_api;
        const snap = await getDocs(window.__fb.colUsers());
        snap.forEach(docSnap=>{
          const d=docSnap.data()||{};
          map.set(docSnap.id, { displayName: d.displayName||'ì‚¬ìš©ì', role: d.role||'user', email: d.email||'' });
        });
      }catch(e){ console.warn('[loadUsersMap] fail', e); }
      return map;
    }

    /* ================= ì§„í–‰ë„/í´ë¦­ ì¹´ìš´íŠ¸ ì €ì¥ì†Œ ================= */
    async function loadProgress(){
      if(window.__cloudReady){
        try{
          const { getDocs } = window.__fb_api;
          const snap = await getDocs(window.__fb.colProgress());
          const obj = {};
          snap.forEach(d => { obj[d.id] = d.data(); });
          // ë¡œì»¬ ì €ì¥ (ê¸°ì¡´ clicks í•„ë“œë¥¼ ë³´ì¡´)
          const local = lsGet(LS_PROG, {});
          const merged = { ...local, ...obj };
          lsSet(LS_PROG, merged);
          return merged;
        }catch(e){
          console.warn('[loadProgress] cloud fail -> local fallback', e);
        }
      }
      return lsGet(LS_PROG, {});
    }
    function getLocalUserProgress(uid){
      const all = lsGet(LS_PROG, {});
      return all[uid] || { learnedIds: [], clicks: {} };
    }
    function setLocalUserProgress(uid, patch){
      const all = lsGet(LS_PROG, {});
      const prev = all[uid] || { learnedIds: [], clicks: {} };
      all[uid] = { learnedIds: prev.learnedIds || [], clicks: prev.clicks || {}, ...patch,
                   learnedIds: patch.learnedIds ? Array.from(new Set(patch.learnedIds)) : (prev.learnedIds||[]),
                   clicks: { ...(prev.clicks||{}), ...(patch.clicks||{}) }
                 };
      lsSet(LS_PROG, all);
      return all[uid];
    }
    async function saveProgressForUser(uid, learnedIds){
      const prev = getLocalUserProgress(uid);
      const merged = setLocalUserProgress(uid, { learnedIds: learnedIds, clicks: prev.clicks||{} });
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db, "progress", uid), merged, { merge:true });
        }catch(e){
          console.warn('[saveProgressForUser] cloud fail (local kept)', e);
        }
      }
    }
    async function incrementUserClick(uid, qid){
      if(!uid) return;
      const prev = getLocalUserProgress(uid);
      const clicks = { ...(prev.clicks||{}) };
      clicks[qid] = (clicks[qid]||0) + 1;
      const merged = setLocalUserProgress(uid, { clicks });
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db, "progress", uid), { clicks }, { merge:true });
        }catch(e){
          console.warn('[incrementUserClick] cloud fail (local kept)', e);
        }
      }
      return merged.clicks[qid];
    }
    function getCurrentUserClicks(){
      if(!currentUser) return {};
      return getLocalUserProgress(currentUser.uid).clicks || {};
    }

    /* ================= ìˆœìœ„/í—¤ë” ================= */
    async function renderRanks(){
      const progress = await loadProgress();
      const usersMap = await loadUsersMap();
      const total = raw.length || 1;

      const rows = Object.keys(progress)
        .map(uid=>{
          const learned = (progress[uid]?.learnedIds || []).length;
          const rate = ((learned / total) * 100).toFixed(1);
          const info = usersMap.get(uid) || { displayName: 'ì‚¬ìš©ì', role: 'user' };
          return { uid, name: info.displayName || 'ì‚¬ìš©ì', role: info.role || 'user', learned, rate };
        })
        .filter(r=> r.role !== 'admin')
        .sort((a,b)=> b.learned - a.learned);

      const html = '<h3>í•™ìŠµì ìˆœìœ„</h3>' + (
        rows.length
          ? rows.map((r,i)=>`<div>${i+1}ìœ„ ${esc(r.name)} â€” ìŠµë“ìˆ˜: ${r.learned}, ìŠµë“ìœ¨: ${r.rate}%</div>`).join('')
          : '<div style="opacity:.7">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'
      );
      document.getElementById('rankList').innerHTML = html;
    }
    async function updateHeaderUser(){
      const rankEl = document.getElementById('headerRank');
      const userEl = document.getElementById('headerUser');
      const lo     = document.getElementById('logoutBtn');

      if(!currentUser){
        rankEl.style.display='none'; userEl.style.display='none'; lo.style.display='none';
        document.getElementById('manageUsersBtn').style.display='none';
        return;
      }
      const progress = await loadProgress();
      const my = progress[currentUser.uid]?.learnedIds || [];
      const myLearned = my.length;
      const total = raw.length || 1;
      const rate = ((myLearned / total) * 100).toFixed(1);

      const usersMap = await loadUsersMap();
      const rows = Object.keys(progress).map(uid=>{
        const learned = (progress[uid]?.learnedIds||[]).length;
        const info = usersMap.get(uid)||{role:'user'};
        return { uid, learned, role: info.role||'user' };
      }).filter(r=> r.role !== 'admin')
        .sort((a,b)=> b.learned - a.learned);
      const idx = rows.findIndex(r=> r.uid === currentUser.uid);

      rankEl.textContent = `ì´ë¬¸ì œìˆ˜: ${total} Â· ìŠµë“ìˆ˜: ${myLearned} Â· ìŠµë“ìœ¨: ${rate}% Â· ìˆœìœ„: ${idx>=0? (idx+1)+'ìœ„':'-'}`;
      userEl.textContent = `ì‚¬ìš©ì: ${currentUser.name}`;

      rankEl.style.display='inline-block';
      userEl.style.display='inline-block';
      lo.style.display    = 'inline-block';

      document.getElementById('manageUsersBtn').style.display = currentUser.role==='admin' ? 'inline-block' : 'none';
    }

    /* ===== í‘œì‹œì´ë¦„ì„ ì¦‰ì‹œ í—¤ë”ì— ë³´ì—¬ì£¼ê¸° ===== */
    function setHeaderImmediate(){
      if(!currentUser) return;
      const userEl = document.getElementById('headerUser');
      const lo     = document.getElementById('logoutBtn');
      userEl.textContent = `ì‚¬ìš©ì: ${currentUser.name}`;
      userEl.style.display = 'inline-block';
      lo.style.display = 'inline-block';
    }

    /* ================= ë² ì´ìŠ¤ ë°ì´í„° ================= */
    const FALLBACK = [
      { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ìƒë‹´ì—ì„œ ë¼í¬ì˜ í•µì‹¬ì€?', answers:['ì§„ì •ì„±, ê³µê°, ì¡´ì¤‘ì„ í†µí•´ ì‹ ë¢°ê´€ê³„ í˜•ì„±'], active:0, extraInfo:'ì‹ ë¢° í˜•ì„±ì„ ìœ„í•´ ìƒë‹´ìì˜ ì§„ì •ì„±Â·ê³µê°Â·ë¬´ì¡°ê±´ì  ì¡´ì¤‘ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.', followups:[{q:'í˜„ì¥ì—ì„œ ì ìš© ì‚¬ë¡€?',a:'ìƒí™©-í–‰ë™-ê²°ê³¼(SAR)ë¡œ ê°„ë‹¨íˆ ì„¤ëª….'}] },
      { subject:'ìƒ˜í”Œê³¼ëª©', question:'ì²­ì†Œë…„ ì •ì±…ì˜ 3ëŒ€ ì¶•ì€?', answers:['ë³´í˜¸, ì°¸ì—¬, ë°œë‹¬'], active:0, extraInfo:'ë³´í˜¸(ìœ„í—˜Â·ê¶Œë¦¬ì¹¨í•´ë¡œë¶€í„° ë³´í˜¸), ì°¸ì—¬(ì˜ì‚¬ê²°ì • ì°¸ì—¬), ë°œë‹¬(ê±´ê°•í•œ ì„±ì¥ ì§€ì›).', followups:[{q:'ê° ì¶•ì˜ ëŒ€í‘œì‚¬ì—…?',a:'ë³´í˜¸: ìœ„ê¸°ì²­ì†Œë…„ ì§€ì› / ì°¸ì—¬: ì²­ì†Œë…„ìš´ì˜ìœ„ / ë°œë‹¬: ì§„ë¡œÂ·ìê¸°ê°œë°œ'}] }
    ];
    async function loadBase(){
      try{
        const r=await fetch('youth_quiz_data.json',{cache:'no-store'});
        if(!r.ok) throw 0;
        const j=await r.json();
        return Array.isArray(j)&&j.length? j : FALLBACK;
      }catch{ return FALLBACK; }
    }
    function standardize(base){
      return base.map(x=>({
        subject: normSubj(x.subject),
        question: x.question,
        answers: Array.isArray(x.answers)? x.answers.filter(Boolean) : [(x.answer||'')].filter(Boolean),
        active: (typeof x.active==='number'? x.active:0),
        extraInfo: (typeof x.extraInfo==='string')? x.extraInfo : '',
        followups: Array.isArray(x.followups)? x.followups.filter(f=>f&&f.q&&f.a) : [],
        _localOnly: true
      }));
    }
    async function mergeWithShared(baseStd){
      const map=new Map();
      baseStd.forEach(q=> map.set(qKey(q), {...q}) );
      const shared = await loadShared();
      shared.forEach(q=>{
        const id=qKey(q);
        if(map.has(id)){
          const cur=map.get(id);
          const mergedAnswers = [...(cur.answers||[]), ...((q.answers||[]).filter(Boolean))];
          const uniq = [];
          const seen = new Set();
          for(const a of mergedAnswers){
            const t = (isAnswerObj(a)? a.text: String(a||'')).trim();
            if(!t) continue;
            if(seen.has(t)) continue;
            seen.add(t);
            uniq.push(a);
          }
          cur.answers = uniq;
          if(!cur.extraInfo && q.extraInfo) cur.extraInfo=q.extraInfo;
          const fu=Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a) : [];
          cur.followups=[...(cur.followups||[]), ...fu];
          cur._localOnly = cur._localOnly || false;
        }else{
          map.set(id,{
            subject:normSubj(q.subject),
            question:q.question,
            answers:(q.answers||[]).filter(Boolean),
            active:(q.active||0),
            extraInfo:(q.extraInfo||''),
            followups:Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a):[],
            _localOnly:false
          });
        }
      });
      const ov = loadLocalOverrides();
      for(const [id, q] of map){
        if(q._localOnly && ov[id]){
          const o = ov[id];
          if(o.answers) q.answers = o.answers;
          if(typeof o.active==='number') q.active = o.active;
          if(typeof o.extraInfo==='string') q.extraInfo = o.extraInfo;
          if(Array.isArray(o.followups)) q.followups = o.followups;
        }
      }
      raw=Array.from(map.values()).map((q,i)=>({...q,_idx:i}));
    }

    async function loadShared(){
      if(window.__cloudReady){
        try{
          const { getDocs } = window.__fb_api;
          const snap = await getDocs(window.__fb.colShared());
          const arr = [];
          snap.forEach(d => arr.push(d.data()));
          lsSet(LS_SHARED, arr);
          return arr;
        }catch(e){
          console.warn('[loadShared] cloud fail -> local fallback', e);
        }
      }
      return lsGet(LS_SHARED, []);
    }
    async function saveShared(array){
      lsSet(LS_SHARED, array);
      if(window.__cloudReady){
        try{
          const { writeBatch, doc } = window.__fb_api;
          const db = window.__fb.db;
          const batch = writeBatch(db);
          array.forEach(rec=>{
            const id = `${normSubj(rec.subject)}::${rec.question}`;
            batch.set(doc(db, "sharedData", id), rec, { merge:true });
          });
          await batch.commit();
        }catch(e){
          console.warn('[saveShared] cloud fail (local kept)', e);
        }
      }
    }
    async function persistQuestion(q){
      const id = qKey(q);
      if (q && q._localOnly){
        saveLocalOverride(id, {
          answers: (q.answers||[]),
          active:  (typeof q.active==='number'? q.active:0),
          extraInfo: (q.extraInfo||''),
          followups: Array.isArray(q.followups)? q.followups.filter(f=>f&&f.q&&f.a):[]
        });
        return;
      }
      const local = lsGet(LS_SHARED, []);
      const rec = { subject:q.subject, question:q.question, answers:q.answers||[], active:q.active||0, extraInfo:q.extraInfo||'', followups:q.followups||[] };
      const i = local.findIndex(x=> qKey(x)===id);
      if(i>=0) local[i]=rec; else local.push(rec);
      lsSet(LS_SHARED, local);
      if(window.__cloudReady){
        try{
          const { setDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await setDoc(doc(db,"sharedData",id), rec, { merge:true });
        }catch(e){
          console.warn('[persistQuestion] cloud fail (local kept)', e);
        }
      }
    }
    async function deleteSharedQuestion(q){
      const id = qKey(q);
      if (q && q._localOnly){
        deleteLocalOverride(id);
        return;
      }
      const local = lsGet(LS_SHARED, []);
      lsSet(LS_SHARED, local.filter(x=> qKey(x)!==id));
      if(window.__cloudReady){
        try{
          const { deleteDoc, doc } = window.__fb_api;
          const db = window.__fb.db;
          await deleteDoc(doc(db, "sharedData", id));
        }catch(e){
          console.warn('[deleteSharedQuestion] cloud fail (local kept)', e);
        }
      }
    }

    /* ================= ìƒ‰ìƒ(í´ë¦­ìˆ˜ ê¸°ë°˜, ë³´ìƒ‰ìœ¼ë¡œ ë³€í™”) ================= */
    function styleFromCount(n){
      const t = Math.max(0, Math.min(1, n/10)); // 0..1 (10íšŒì—ì„œ ìµœëŒ€ ë³€í™”)
      const baseHue = 230;           // ê¸°ë³¸ íŒŒë‘í†¤
      const compHue = (baseHue + 180) % 360; // ë³´ìƒ‰ (230+180=410 â†’ 50, ì£¼í™©í†¤)
      const hue = baseHue*(1-t) + compHue*t;
      const sat = 40 + 30*t;         // 40% â†’ 70%
      const light = 22 + (20*t);     // 22% â†’ 42%
      const bg = `hsl(${hue}, ${sat}%, ${light}%)`;
      const border = `hsl(${hue}, ${sat+5}%, ${light-10}%)`;
      return { bg, border };
    }

    /* ================= ì‚¬ìš©ì í•„í„°/ì¹´ìš´íŠ¸ ================= */
    async function applyLearnedFilterForCurrentUser(){
      const p = await loadProgress();
      const learned = currentUser ? new Set((p[currentUser.uid]?.learnedIds)||[]) : new Set();
      data = raw.filter(q=> !learned.has(qKey(q))).map(q=>({...q}));
    }
    async function updateCounts(){
      const subj = currentSubject();
      const p = await loadProgress();
      const learnedIds = currentUser ? new Set((p[currentUser.uid]?.learnedIds || [])) : new Set();
      const subjectAll = raw.filter(q => normSubj(q.subject) === subj);
      const subjectTotal = subjectAll.length;
      const subjectLearned = subjectAll.reduce((acc,q)=>{
        return acc + (learnedIds.has(`${normSubj(q.subject)}::${q.question}`) ? 1 : 0);
      }, 0);
      document.getElementById('countTotal').textContent   = `ê³¼ëª©ë³„ : ì´ë¬¸ì œìˆ˜ ${subjectTotal}`;
      document.getElementById('countLearned').textContent = `ê³¼ëª©ë³„ : ìŠµë“ìˆ˜ ${subjectLearned}`;
    }

    /* ================= ê³¼ëª©/ë¦¬ìŠ¤íŠ¸ ================= */
    function subjects(){
      const list = raw.map(q => normSubj(q.subject));
      return Array.from(new Set(list)).sort((a,b)=> a.localeCompare(b));
    }
    function initSubjectSelect(){
      const sel = document.getElementById('subjectSelect');
      const prev = sel.value;
      const subs = subjects();
      sel.innerHTML = subs.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
      sel.value = subs.includes(prev) ? prev : (subs[0] || 'ê¸°íƒ€');
      sel.onchange = async ()=>{
        await renderBySubject(currentSubject());
        await updateCounts();
      };
      renderBySubject(currentSubject());
      updateCounts();
    }
    function currentSubject(){
      const sel=document.getElementById('subjectSelect');
      const subs = subjects();
      if(sel && sel.value && subs.includes(sel.value)) return sel.value;
      return subs[0] || 'ê¸°íƒ€';
    }
    async function renderBySubject(subj){
      const grid=document.getElementById('grid');
      if(!raw || raw.length===0){
        grid.innerHTML = `<div style="padding:12px;opacity:.7">ë¬¸í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (youth_quiz_data.jsonì„ í™•ì¸)</div>`;
        return;
      }
      const clicks = getCurrentUserClicks();
      const list=data.filter(x=>normSubj(x.subject)===subj)
        .map(q=>{
          const id = qKey(q);
          const cnt = clicks[id]||0;
          const { bg, border } = styleFromCount(cnt);
          const safeTitle = `${q.question} (ë‚˜ì˜ ì‹œë„ ${cnt}íšŒ)`;
          return `<button class="qbtn" style="background:${bg};border-color:${border}" onclick="openQuestion(${q._idx})" title="${esc(safeTitle)}">${esc(q.question)}</button>`;
        }).join('');
      if(list){
        grid.innerHTML=list;
      }else{
        const totalSubjCount = raw.filter(x=>normSubj(x.subject)===subj).length;
        grid.innerHTML = `<div style="padding:12px;opacity:.7">ì´ ê³¼ëª©ì˜ ë¯¸ìŠµë“ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.${totalSubjCount? ' (ëª¨ë“  ë¬¸í•­ì„ ìŠµë“í–ˆìŠµë‹ˆë‹¤)': ''}</div>`;
      }
    }

    /* ================= ì¸ì¦/ë¡œê·¸ì¸ íë¦„ ================= */
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const nameEl = document.getElementById('displayName');

    async function postLoginUI(){
      document.getElementById('loginPanel').style.display='none';
      document.getElementById('mainPanel').style.display='block';
      document.getElementById('logoutBtn').style.display='inline-block';
      document.getElementById('grid').innerHTML = '<div style="opacity:.7;padding:12px">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
      await quickRenderBase();
      await bootstrap();
      await renderRanks();
      await updateHeaderUser();
    }

    document.getElementById('loginBtn').onclick = async ()=>{
      try{
        const email=(emailEl.value||'').trim();
        const pass=passEl.value||'';
        if(!email||!pass){ showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const { signInWithEmailAndPassword } = window.__fb_api;
        await signInWithEmailAndPassword(window.__fb.auth, email, pass);
        const u = window.__fb.auth.currentUser;
        if (u) {
          await ensureUserProfile(u);
          let role = 'user';
          try{
            const usersMap = await loadUsersMap();
            role = (usersMap.get(u.uid)?.role)||'user';
          }catch(_){}
          currentUser = { uid: u.uid, name: u.displayName || (u.email ? u.email.split('@')[0] : 'ì‚¬ìš©ì'), role };
          setHeaderImmediate();
          await postLoginUI();
        }
      }catch(err){
        const code = err?.code || '';
        const map = {
          'auth/invalid-credential':'ìê²© ì¦ëª…ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤(ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜ ë˜ëŠ” ë‹¤ë¥¸ ë¡œê·¸ì¸ ë°©ì‹).',
          'auth/user-not-found':'ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íšŒì›ê°€ì…ì„ í•´ì£¼ì„¸ìš”.',
          'auth/wrong-password':'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'
        };
        showError(map[code] || `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${code || err?.message || err}`);
      }
    };

    document.getElementById('signupBtn').onclick = async ()=>{
      try{
        const email=(emailEl.value||'').trim();
        const pass=passEl.value||'';
        const disp=(nameEl.value||'').trim();
        if(!email||!pass){ showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const { createUserWithEmailAndPassword, updateProfile } = window.__fb_api;
        const cred = await createUserWithEmailAndPassword(window.__fb.auth, email, pass);
        if(disp){ await updateProfile(cred.user, { displayName: disp }); }
        await ensureUserProfile(cred.user);
        showError('íšŒì›ê°€ì… ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.');
      }catch(err){
        const code = err?.code || '';
        const map = {
          'auth/email-already-in-use':'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì„ ì‚¬ìš©í•˜ì„¸ìš”.',
          'auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/weak-password':'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤(ìµœì†Œ 6ì).',
          'auth/operation-not-allowed':'Email/Password ì œê³µìê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
          'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'
        };
        showError(map[code] || `íšŒì›ê°€ì… ì‹¤íŒ¨: ${code || err?.message || err}`);
      }
    };

    document.getElementById('resetPwBtn').onclick = async ()=>{
      try{
        const email = (emailEl.value||'').trim();
        if(!email){ showError('ì¬ì„¤ì •í•  ì´ë©”ì¼ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const mod = await import('https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js');
        await mod.sendPasswordResetEmail(window.__fb.auth, email);
        showError('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì„ í™•ì¸í•˜ì„¸ìš”.');
      }catch(err){
        const code = err?.code || '';
        const map = {
          'auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/user-not-found':'í•´ë‹¹ ì´ë©”ì¼ì˜ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.',
          'auth/network-request-failed':'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.'
        };
        showError(map[code] || `ì¬ì„¤ì • ì‹¤íŒ¨: ${code || err?.message || err}`);
      }
    };

    document.getElementById('logoutBtn').onclick = async ()=>{
      try{
        const { signOut } = window.__fb_api;
        await signOut(window.__fb.auth);
      }catch(e){
        console.warn('[logout] fail', e);
      }finally{
        currentUser = null;
        document.getElementById('mainPanel').style.display='none';
        document.getElementById('loginPanel').style.display='block';
        document.getElementById('logoutBtn').style.display='none';
        document.getElementById('headerUser').style.display='none';
        document.getElementById('headerRank').style.display='none';
        document.getElementById('manageUsersBtn').style.display='none';
      }
    };

    /*================= ì¸ì¦ ìƒíƒœ ë³€í™” í•¸ë“¤ëŸ¬ =================*/
    (function watchAuth(){
      if(!window.__cloudReady) return;
      const { onAuthStateChanged } = window.__fb_api;
      onAuthStateChanged(window.__fb.auth, async (user)=>{
        if(user){
          await ensureUserProfile(user);
          let role='user';
          try{
            const usersMap = await loadUsersMap();
            role = (usersMap.get(user.uid)?.role)||'user';
          }catch(_){}
          currentUser = {
            uid: user.uid,
            name: user.displayName || (user.email ? user.email.split('@')[0] : 'ì‚¬ìš©ì'),
            role
          };
          const userEl = document.getElementById('headerUser');
          const lo = document.getElementById('logoutBtn');
          userEl.textContent = `ì‚¬ìš©ì: ${currentUser.name}`;
          userEl.style.display = 'inline-block';
          lo.style.display = 'inline-block';
          await postLoginUI();
        }else{
          currentUser = null;
          document.getElementById('mainPanel').style.display='none';
          document.getElementById('loginPanel').style.display='block';
          document.getElementById('logoutBtn').style.display='none';
          document.getElementById('manageUsersBtn').style.display='none';
          await renderRanks();
          await updateHeaderUser();
        }
      });
    })();

    /* ================= ì§„í–‰ë„ ì´ˆê¸°í™” ================= */
    document.getElementById('resetProgress').onclick = async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      await saveProgressForUser(currentUser.uid, []);
      await applyLearnedFilterForCurrentUser();
      await renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    };

    /* ================= ë¹ ë¥¸ 1ë‹¨ê³„ ë Œë” ================= */
    async function quickRenderBase(){
      const base = await loadBase();
      const std  = standardize(base);
      raw = std.map((q,i)=>({...q,_idx:i}));
      await applyLearnedFilterForCurrentUser();
      initSubjectSelect();
      const sel = document.getElementById('subjectSelect');
      if(sel && !sel.value){
        const subs = subjects();
        if(subs.length) sel.value = subs[0];
      }
      await renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    }

    /* ================= ì§ˆë¬¸ ëª¨ë‹¬/ìŒì„±/ìœ ì‚¬ë„/ì¶”ê°€ê¸°ëŠ¥ ================= */
    async function openQuestion(idx){
      currentIdx=idx;
      const q=raw.find(x=>x._idx===idx); if(!q) return;
      document.getElementById('qTitle').textContent=q.question;
      document.getElementById('userAnswer').textContent='';
      document.getElementById('result').innerHTML='';
      renderAnswerList();
      document.getElementById('extraInfo').value=q.extraInfo||'';
      renderFollowups();
      document.getElementById('qd').showModal();
      speak(q.question);

      // ì‚¬ìš©ìë³„ í´ë¦­ ì¹´ìš´íŠ¸ ì¦ê°€ + ë²„íŠ¼ ìƒ‰ ì¦‰ì‹œ ê°±ì‹ 
      if(currentUser){
        const id = qKey(q);
        await incrementUserClick(currentUser.uid, id);
        await renderBySubject(currentSubject());
      }
    }
    function closeQuestion(){
      stopRecognition(true);
      document.getElementById('qd').close();
    }
    window.openQuestion = openQuestion;
    document.getElementById('closeBtn').onclick = closeQuestion;

    function speak(txt){ const u=new SpeechSynthesisUtterance(txt); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u); }
    document.getElementById('speakBtn').onclick = ()=>{ const q=raw.find(x=>x._idx===currentIdx); if(q) speak(q.question); };

    // ì¶”ê°€ì„¤ëª… ë“£ê¸°
    document.getElementById('ttsExtraBtn').onclick = ()=>{
      const txt = (document.getElementById('extraInfo').value||'').trim();
      if(!txt){ alert('ì¶”ê°€ì„¤ëª… ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      speak(txt);
    };

    // ìƒë‹¨ 'ì •ë‹µ ë“£ê¸°' ë²„íŠ¼ì€ ì œê±°ë¨ (ì¸ë¼ì¸ ë²„íŠ¼ë§Œ ìœ ì§€)

    function startRecognition(){
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!window.SpeechRecognition){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      recognition=new SpeechRecognition();
      recognition.lang='ko-KR'; recognition.continuous=true; recognition.interimResults=true;
      recFinalOnly = '';
      document.getElementById('userAnswer').innerHTML = `<span class="blink">ë‹µë³€ë…¹ìŒì¤‘.....:</span>`;
      recognition.onresult=(event)=>{
        for(let i=event.resultIndex;i<event.results.length;i++){
          const t=event.results[i][0].transcript;
          if(event.results[i].isFinal){ recFinalOnly += t + ' '; }
        }
      };
      recognition.start();
    }
    function stopRecognition(fromClose=false){
      if(recognition){
        try{ recognition.stop(); }catch(_){}
        recognition=null;
      }
      if(!fromClose){
        const clean = (recFinalOnly||'').replace(/\s+/g,' ').trim();
        document.getElementById('userAnswer').textContent = clean || '';
      }
    }
    document.getElementById('recordBtn').onclick = ()=>{ startRecognition(); };

    function similarity(a,b){
      const sa=new Set(String(a).split(/\s+/).filter(Boolean));
      const sb=new Set(String(b).split(/\s+/).filter(Boolean));
      let inter=0; sa.forEach(w=>{ if(sb.has(w)) inter++; });
      return inter/(sa.size+sb.size-inter||1);
    }
    function getActiveAnswerText(q){
      if(!q || !Array.isArray(q.answers) || !q.answers.length) return '';
      const idx = (q.active||0);
      const pick = q.answers[idx] || q.answers[0];
      return answerText(pick);
    }
    document.getElementById('submitBtn').onclick = ()=>{
      const q=raw.find(x=>x._idx===currentIdx);
      if(!q) return;
      stopRecognition(false);
      const gold=getActiveAnswerText(q);
      const user=document.getElementById('userAnswer').textContent;
      if(!gold){
        document.getElementById('result').innerHTML = `<div class='answer-box'>ì •ë‹µì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. <b>â€œì •ë‹µ ì¶”ê°€â€</b> ë²„íŠ¼ìœ¼ë¡œ ì •ë‹µì„ ë“±ë¡í•˜ì„¸ìš”.</div>`;
        return;
      }
      const sim=similarity(user,gold);
      document.getElementById('result').innerHTML = `<div class='answer-box'>${esc(gold)}</div><div class='score'>ìœ ì‚¬ë„ ${(sim*100).toFixed(1)}%</div>`;
      speak('ì •ë‹µì…ë‹ˆë‹¤. ' + gold);
    };

    document.getElementById('learnedBtn').onclick = async ()=>{
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      const q = raw.find(x=>x._idx===currentIdx); if(!q) return;
      const id = qKey(q);

      data = data.filter(item => qKey(item) !== id);
      await renderBySubject(currentSubject());
      closeQuestion();

      try{
        const all = await loadProgress();
        const mine = new Set((all[currentUser.uid]?.learnedIds || []));
        mine.add(id);
        await saveProgressForUser(currentUser.uid, Array.from(mine));
      }catch(e){ console.warn('[learned] ì €ì¥ ì‹¤íŒ¨ â€“ ë¡œì»¬ ìœ ì§€', e); }

      try{
        await updateCounts();
        await updateHeaderUser();
        await renderRanks();
      }catch(e){}
    };

    function canEditAnswer(ans){
      if(!currentUser) return false;
      if(currentUser.role==='admin') return true;
      const owner = answerOwnerUid(ans);
      return owner && owner === currentUser.uid;
    }

    function renderAnswerList(){
      const holder=document.getElementById('extraAnswers');
      const q=raw.find(x=>x._idx===currentIdx);
      if(!q){ holder.innerHTML=''; return; }

      const items=(q.answers||[]).map((ans,i)=>{
        const checked=(q.active||0)===i?'checked':'';
        const txt = answerText(ans);
        const ownerTag = answerOwnerName(ans) ? ` &lt;${esc(answerOwnerName(ans))}&gt;` : '';
        const delBtn = canEditAnswer(ans) ? `<button class="btn danger" data-del-ans="${i}">ğŸ—‘</button>` : '';
        return `<div style="display:flex;gap:8px;align-items:flex-start;margin:6px 0">
          <input type="radio" name="ansPick" value="${i}" ${checked} style="margin-top:4px"/>
          <div style="flex:1">${esc(txt)}${ownerTag}</div>
          ${delBtn}
        </div>`;
      }).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</div>';

      holder.innerHTML =
        `<div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0 6px; flex-wrap:wrap">
           <h3 style="margin:0">ì •ë‹µ ëª©ë¡</h3>
           <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
             <button id="addAnswerBtn_inline" class="btn">â• ì •ë‹µ ì¶”ê°€</button>
             <button id="ttsAnswerBtn_inline" class="btn">ğŸ”Š ì •ë‹µ ë“£ê¸°</button>
           </div>
         </div>` + items;

      holder.querySelectorAll('input[name="ansPick"]').forEach(r=>{
        r.addEventListener('change', async (e)=>{
          q.active = parseInt(e.target.value,10)||0;
          await persistQuestion(q);
        });
      });
      holder.querySelectorAll('[data-del-ans]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const i=parseInt(btn.getAttribute('data-del-ans'),10);
          const target = (q.answers||[])[i];
          if(!canEditAnswer(target)){ alert('ì´ ì •ë‹µì„ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
          q.answers.splice(i,1);
          if((q.active||0)>=q.answers.length) q.active=Math.max(0,q.answers.length-1);
          await persistQuestion(q);
          renderAnswerList();
        });
      });

      const addInline = holder.querySelector('#addAnswerBtn_inline');
      if(addInline){
        addInline.addEventListener('click', async ()=>{
          if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
          const val=prompt('ì¶”ê°€í•  ì •ë‹µ(ë³€í˜•)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!val) return;
          q.answers=q.answers||[];
          const rec = {
            text: val,
            ownerUid: currentUser.uid,
            ownerName: currentUser.name||'ì‚¬ìš©ì',
            createdAt: new Date().toISOString()
          };
          const exists = (q.answers||[]).some(a=>answerText(a)===val);
          if(!exists) q.answers.push(rec);
          q.active=q.answers.length-1;
          await persistQuestion(q);
          renderAnswerList();
        });
      }

      const ttsInline = holder.querySelector('#ttsAnswerBtn_inline');
      if(ttsInline){
        ttsInline.addEventListener('click', ()=>{
          const gold = getActiveAnswerText(q);
          if(!gold){ alert('ë“±ë¡ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
          speak(gold);
        });
      }
    }
    document.getElementById('addAnswerBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      if(!currentUser){ alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }
      const val=prompt('ì¶”ê°€í•  ì •ë‹µ(ë³€í˜•)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!val) return;
      q.answers=q.answers||[];
      const rec = {
        text: val,
        ownerUid: currentUser.uid,
        ownerName: currentUser.name||'ì‚¬ìš©ì',
        createdAt: new Date().toISOString()
      };
      const exists = (q.answers||[]).some(a=>answerText(a)===val);
      if(!exists) q.answers.push(rec);
      q.active=q.answers.length-1;
      await persistQuestion(q);
      renderAnswerList();
    };
    document.getElementById('saveExtraInfoBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      q.extraInfo=(document.getElementById('extraInfo').value||'').trim();
      await persistQuestion(q);
      alert('ì¶”ê°€ì„¤ëª…ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
    };
    (function(){
      const btn = document.getElementById('expandExtraInfoBtn');
      let expanded=false;
      const ta=document.getElementById('extraInfo');
      ta.style.maxHeight='50vh';
      ta.style.minHeight='80px';
      btn.addEventListener('click', ()=>{
        expanded=!expanded;
        if(expanded){
          ta.style.maxHeight='80vh';
          ta.style.minHeight='60vh';
          btn.textContent='ğŸ” ì ‘ê¸°';
        } else {
          ta.style.maxHeight='50vh';
          ta.style.minHeight='80px';
          btn.textContent='ğŸ” ì „ì²´ë³´ê¸°';
        }
      });
    })();
    function renderFollowups(){
      const box=document.getElementById('followupsBox');
      const q=raw.find(x=>x._idx===currentIdx);
      if(!q){ box.innerHTML=''; return; }
      const items=(q.followups||[]).map((f,i)=>`<div style="display:flex;gap:8px;flex-direction:column;border:1px solid #1f2a55;border-radius:10px;padding:8px;margin:6px 0">
        <div><b>Q${i+1}.</b> ${esc(f.q)}</div>
        <div><b>A${i+1}.</b> ${esc(f.a)}</div>
        <div><button class='btn danger' data-del-fu='${i}'>ğŸ—‘ ì‚­ì œ</button></div>
      </div>`).join('') || '<div style="opacity:.7">ë“±ë¡ëœ ì¶”ê°€ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      box.innerHTML=items;
      box.querySelectorAll('[data-del-fu]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const i=parseInt(btn.getAttribute('data-del-fu'),10);
          q.followups.splice(i,1);
          await persistQuestion(q);
          renderFollowups();
        });
      });
    }
    document.getElementById('addFollowupBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      const fq=(document.getElementById('fuQ').value||'').trim();
      const fa=(document.getElementById('fuA').value||'').trim();
      if(!fq||!fa){ alert('ì¶”ê°€ì§ˆë¬¸ê³¼ ì¶”ê°€ë‹µë³€ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      q.followups=q.followups||[];
      q.followups.push({q:fq,a:fa});
      document.getElementById('fuQ').value=''; document.getElementById('fuA').value='';
      await persistQuestion(q);
      renderFollowups();
    };

    /* ================= ì§ˆë¬¸ ì¶”ê°€/ì‚­ì œ(ê³µìœ ) ================= */
    /*
    document.getElementById('addQuestionBtn').onclick = async ()=>{
      const subj=prompt('ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!subj) return;
      const ques=prompt('ìƒˆ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!ques) return;
      const answ=prompt('ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)ì„ ì…ë ¥í•˜ì„¸ìš”'); if(!answ) return;
      const id = `${normSubj(subj)}::${ques}`;
      if(raw.some(x=> qKey(x)===id)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¬¸í•­ì…ë‹ˆë‹¤.'); return; }
      const seed = {
        subject:normSubj(subj),
        question:ques,
        answers:[{ text: answ, ownerUid: currentUser?.uid||'', ownerName: currentUser?.name||'', createdAt: new Date().toISOString() }],
        active:0,
        extraInfo: `â— ì§ˆë¬¸ ì˜ë„: â€œ${ques}â€\nâ— ë‹µë³€ êµ¬ì¡°: (ì •ì˜)â†’(í•µì‹¬)â†’(ì‚¬ë¡€)â†’(ë³´ì™„)\nâ— ë§ë¨¸ë¦¬: ê²°ë¡ â†’ê·¼ê±° 2~3â†’ì‚¬ë¡€â†’ìš”ì•½`,
        followups: [
          { q:'í˜„ì¥ ì ìš© ì‚¬ë¡€?', a:'ìƒí™©-í–‰ë™-ê²°ê³¼(SAR)ë¡œ ê°„ë‹¨ ì„¤ëª…' },
          { q:'ê´€ë ¨ ì§€ì¹¨/ìœ¤ë¦¬ëŠ”?', a:'í•µì‹¬ ì¡°í•­ê³¼ ì—°ê²° ì´ìœ  1~2ë¬¸ì¥' }
        ]
      };
      const current = await loadShared();
      current.push(seed);
      await saveShared(current);
      await bootstrap();
    };
    */

    document.getElementById('addQuestionBtn').onclick = openAddDialog;
    
    document.getElementById('deleteQuestionBtn').onclick = async ()=>{
      const q=raw.find(x=>x._idx===currentIdx); if(!q) return;
      if(!confirm('ì´ ì§ˆë¬¸ì„ ëª¨ë“  ì‚¬ìš©ìì—ê²Œì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await deleteSharedQuestion(q);
      await bootstrap();
    };

    /* ================= ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ================= */
    document.addEventListener('DOMContentLoaded', ()=>{
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const importFile = document.getElementById('importFile');

      function download(filename, text){
        const blob = new Blob([text], {type: 'application/json;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        a.remove();
      }

      async function exportAll(){
        try{
          const shared = await loadShared();
          const progress = await loadProgress();
          const payload = {
            version: 5,
            exportedAt: new Date().toISOString(),
            shared,
            progress
          };
          download('youth-interview-backup.json', JSON.stringify(payload, null, 2));
          alert('ë‚´ë³´ë‚´ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){
          alert('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + (e?.message || e));
        }
      }

      async function importAll(file){
        try{
          const text = await file.text();
          const obj = JSON.parse(text);
          if(typeof obj !== 'object' || obj === null) throw new Error('JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
          if(!('shared' in obj) || !('progress' in obj)) throw new Error('shared/progress í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
          if(!Array.isArray(obj.shared)) throw new Error('sharedëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
          if(typeof obj.progress !== 'object') throw new Error('progressëŠ” ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
          if(!confirm('í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì“°ê¸°/ë³‘í•©ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;

          await saveShared(obj.shared);
          const names = Object.keys(obj.progress||{});
          for(const key of names){
            const learned = Array.from(new Set((obj.progress[key]?.learnedIds)||[]));
            const clicks  = (obj.progress[key]?.clicks)||{};
            setLocalUserProgress(key, { learnedIds: learned, clicks });
            if(window.__cloudReady){
              const { setDoc, doc } = window.__fb_api;
              const db = window.__fb.db;
              await setDoc(doc(db, "progress", key), { learnedIds: learned, clicks }, { merge:true });
            }
          }

          await bootstrap();
          alert('ê°€ì ¸ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }catch(e){
          console.error(e);
          alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (e?.message||e));
        }
      }

      if(exportBtn && !exportBtn.__bound){ exportBtn.addEventListener('click', exportAll); exportBtn.__bound=true; }
      if(importBtn && importFile && !importBtn.__bound){
        importBtn.addEventListener('click', ()=> importFile.click());
        importFile.addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if(f) importAll(f);
          e.target.value = '';
        });
        importBtn.__bound=true;
      }
    });

    /* ================= [ì¶”ê°€] ê¸€ì í¬ê¸° í† ê¸€ ================= */
    (function(){
      const btn = document.getElementById('zoomBtn');
      if(!btn) return;
      const steps = [1, 1.15, 1.3];   // ë°°ìœ¨ ë‹¨ê³„
      let i = 0;
      const apply = () => {
        document.documentElement.style.setProperty('--scale', steps[i]);
        btn.textContent = (steps[i]===1) ? 'ê¸€ì í¬ê²Œ' : (steps[i]===1.15 ? 'ë” í¬ê²Œ' : 'ê¸°ë³¸ í¬ê¸°');
      };
      btn.addEventListener('click', ()=>{ i = (i+1) % steps.length; apply(); });
      apply();
    })();
    /* ================= [ì¶”ê°€ ë] ================= */

    /* ================= ê´€ë¦¬ì: ì‚¬ìš©ì ê´€ë¦¬ ================= */
    async function openUserManage(){
      if(!currentUser || currentUser.role!=='admin'){ alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      const listEl = document.getElementById('userMngList');
      listEl.innerHTML = '<div style="opacity:.7">ë¡œë”© ì¤‘â€¦</div>';
      const usersMap = await loadUsersMap();
      const items = [];
      for(const [uid, info] of usersMap.entries()){
        if(info.role==='admin') continue; // ê´€ë¦¬ì ìˆ¨ê¹€
        const row = `
          <div style="display:flex;gap:10px;align-items:center;border:1px solid #283162;padding:8px;border-radius:10px">
            <div style="flex:1">
              <div><b>${esc(info.displayName||'ì‚¬ìš©ì')}</b> <span class="pill">${esc(info.role||'user')}</span></div>
              <div style="opacity:.7;font-size:12px">${esc(info.email||'')}</div>
            </div>
            <button class="btn danger" data-del-user="${uid}">ì‚¬ìš©ì ì‚­ì œ</button>
          </div>
        `;
        items.push(row);
      }
      listEl.innerHTML = items.length ? items.join('') : '<div style="opacity:.7">ì¼ë°˜ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      listEl.querySelectorAll('[data-del-user]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const uid = btn.getAttribute('data-del-user');
          if(!confirm('í•´ë‹¹ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì§„í–‰ë„ë„ í•¨ê»˜ ì‚­ì œ)')) return;
          try{
            if(window.__cloudReady){
              const { deleteDoc, doc } = window.__fb_api;
              const db = window.__fb.db;
              await deleteDoc(doc(db,'users', uid));
              await deleteDoc(doc(db,'progress', uid));
            }
            const prog = lsGet(LS_PROG,{});
            delete prog[uid];
            lsSet(LS_PROG, prog);
            await openUserManage();
            await renderRanks();
            await updateHeaderUser();
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          }catch(e){
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + (e?.message||e));
          }
        });
      });
      document.getElementById('userMngDlg').showModal();
    }
    document.getElementById('manageUsersBtn').addEventListener('click', openUserManage);
    document.getElementById('userMngClose').addEventListener('click', ()=> document.getElementById('userMngDlg').close());

    /* ================= ìƒˆ ì§ˆë¬¸ ì¶”ê°€: í¼ ë‹¤ì´ì–¼ë¡œê·¸ ================= */
    function add_makeAnswerRow(value=''){
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.gap = '8px';
      wrap.style.alignItems = 'center';
    
      const ta = document.createElement('textarea');
      ta.rows = 2;
      ta.placeholder = 'ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)ì„ ì…ë ¥í•˜ì„¸ìš”';
      ta.style.flex = '1';
      ta.value = value || '';
    
      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = 'ğŸ—‘';
      del.onclick = () => wrap.remove();
    
      wrap.appendChild(ta);
      wrap.appendChild(del);
      return wrap;
    }
    function add_makeFUrow(qVal='', aVal=''){
      const card = document.createElement('div');
      card.style.border = '1px solid #1f2a55';
      card.style.borderRadius = '10px';
      card.style.padding = '8px';
      card.style.display = 'flex';
      card.style.flexDirection = 'column';
      card.style.gap = '6px';
    
      const tq = document.createElement('textarea');
      tq.rows = 2; tq.placeholder = 'ì¶”ê°€ì§ˆë¬¸';
      tq.value = qVal || '';
    
      const ta = document.createElement('textarea');
      ta.rows = 2; ta.placeholder = 'ì¶”ê°€ë‹µë³€';
      ta.value = aVal || '';
    
      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = 'ğŸ—‘ ì‚­ì œ';
      del.style.alignSelf = 'flex-end';
      del.onclick = () => card.remove();
    
      card.appendChild(tq);
      card.appendChild(ta);
      card.appendChild(del);
      return card;
    }
    
    function openAddDialog(){
      const dlg = document.getElementById('addDlg');
      const pill = document.getElementById('addDlgSubjectPill');
      const subj = currentSubject();
      pill.textContent = `ê³¼ëª©: ${subj} (ìë™ ì„¤ì •)`;
    
      // ì´ˆê¸°í™”
      document.getElementById('addQ').value = '';
      document.getElementById('addExtra').value = '';
      const ansBox = document.getElementById('addAnswersBox');
      ansBox.innerHTML = '';
      ansBox.appendChild(add_makeAnswerRow()); // ìµœì†Œ 1ì¹¸
      const fuBox = document.getElementById('addFollowupsBox');
      fuBox.innerHTML = '';
    
      dlg.showModal();
    }
    function closeAddDialog(){ document.getElementById('addDlg').close(); }
    
    async function saveAddDialog(){
      // ìˆ˜ì§‘
      const subj = currentSubject();
      const q = (document.getElementById('addQ').value||'').trim();
      const extra = (document.getElementById('addExtra').value||'').trim();
    
      if(!q){ alert('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    
      const ansBox = document.getElementById('addAnswersBox');
      const ansTexts = Array.from(ansBox.querySelectorAll('textarea'))
        .map(t => (t.value||'').trim())
        .filter(Boolean);
    
      if(ansTexts.length === 0){
        alert('ì •ë‹µ(ëª¨ë²”ë‹µì•ˆ)ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
    
      const fuBox = document.getElementById('addFollowupsBox');
      const fuCards = Array.from(fuBox.children);
      const followups = fuCards.map(card => {
        const [tq, ta] = card.querySelectorAll('textarea');
        const qv = (tq.value||'').trim();
        const av = (ta.value||'').trim();
        return (qv && av) ? { q: qv, a: av } : null;
      }).filter(Boolean);
    
      // ì €ì¥ ë ˆì½”ë“œ
      const answers = ansTexts.map((t, idx) => ({
        text: t,
        ownerUid: currentUser?.uid || '',
        ownerName: currentUser?.name || '',
        createdAt: new Date().toISOString()
      }));
      const seed = {
        subject: subj,
        question: q,
        answers,
        active: 0,               // ì²« ì •ë‹µ í™œì„±
        extraInfo: extra,
        followups
      };
    
      // ì¤‘ë³µ ì²´í¬
      const id = `${subj}::${q}`;
      if(raw.some(x=> `${normSubj(x.subject)}::${x.question}` === id)){
        if(!confirm('ì´ë¯¸ ê°™ì€ ì§ˆë¬¸ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      }
    
      try{
        const current = await loadShared();
        current.push(seed);
        await saveShared(current);
        await bootstrap();
        closeAddDialog();
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(e){
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (e?.message||e));
      }
    }
    
    /* ë²„íŠ¼ ë°”ì¸ë”© */
    document.getElementById('addDlgClose').addEventListener('click', closeAddDialog);
    document.getElementById('addDlgSave').addEventListener('click', saveAddDialog);
    document.getElementById('addAnsRowBtn').addEventListener('click', ()=>{
      document.getElementById('addAnswersBox').appendChild(add_makeAnswerRow());
    });
    document.getElementById('addFUrowBtn').addEventListener('click', ()=>{
      document.getElementById('addFollowupsBox').appendChild(add_makeFUrow());
    });


    


    
    /* ================= ë¶€íŠ¸ìŠ¤íŠ¸ë© ================= */
    async function bootstrap(){
      const base=await loadBase();
      const std = standardize(base);
      await mergeWithShared(std);
      await applyLearnedFilterForCurrentUser();
      initSubjectSelect();
      await renderBySubject(currentSubject());
      await updateCounts();
      await renderRanks();
      await updateHeaderUser();
    }

    // ì´ˆê¸°: ë¡œê·¸ì¸ ì „ì—ë„ ìˆœìœ„(ê´€ë¦¬ì ì œì™¸) ë¨¼ì € ë³´ì—¬ì¤Œ
    (async () => {
      const base = await loadBase();
      const std  = standardize(base);
      raw = std.map((q,i)=>({...q,_idx:i}));
      await renderRanks();
    })();
  </script>
</body>
</html>
